import { Component, Inject, ViewChild } from '@angular/core';
import { DataTableDirective } from 'angular-datatables';
import { DASHLET_CONSTANTS, DATA_SERVICE, DEFAULT_CONFIG } from '../../tokens/index';
import { IReportType, ReportState } from '../../types/index';
import { BaseComponent } from '../base/base.component';
import { TABLE_DEFAULT_CONFIG } from './defaultConfiguration';
import * as jsonexport from "jsonexport/dist";
import { sortBy, map, get, omitBy } from 'lodash-es';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
import * as i2 from "angular-datatables";
import * as i3 from "../filters/filters.component";
const jsonExport = jsonexport;
export class DtTableComponent extends BaseComponent {
    constructor(dataService, defaultConfig, CONSTANTS) {
        super(dataService);
        this.dataService = dataService;
        this.CONSTANTS = CONSTANTS;
        this.reportType = IReportType.TABLE;
        this.inputParameters = {};
        this.exportOptions = ['csv'];
        this.rowClickHandler = (row, data, index) => {
            const self = this;
            $('td', row).off('click');
            $('td', row).on('click', () => {
                this.events.emit({
                    type: 'CLICK',
                    event: data
                });
            });
            return row;
        };
        this._addDefaultToColumn = column => {
            return { ...this._defaultConfig['columnConfig'], ...column };
        };
        this._defaultConfig = defaultConfig;
    }
    set dataTableElement(element) {
        if (!element)
            return;
        this._dtClosure = this._tableOpsClosure(element && element['dtInstance']);
    }
    async initialize({ config, type, data }) {
        if (!(config && type && data))
            throw new SyntaxError(this.CONSTANTS.INVALID_INPUT);
        this.config = config = { ...config, type };
        const fetchedJSON = this.data = await this.fetchData(data).toPromise().catch(err => []);
        this.builder(config, fetchedJSON);
        this._isInitialized = true;
        this.state.emit(ReportState.DONE);
    }
    builder(config, data) {
        const { columnConfig, ...others } = config;
        const columns = columnConfig.map(this._addDefaultToColumn);
        const columnsSortedByIndex = sortBy(columns, ['index']);
        this._setTableOptions({
            ...others,
            data,
            columns: columnsSortedByIndex,
            rowCallback: this.rowClickHandler.bind(this)
        });
    }
    _setTableOptions(config = {}) {
        this.inputParameters = {
            ...this._defaultConfig['tableLevelConfig'],
            ...this.inputParameters,
            ...config
        };
        this.$context = { data: this.data, config: this.config, inputParameters: this.inputParameters, exportOptions: this.exportOptions, reset: false };
    }
    getRowsCount() {
        return this._dtClosure && this._dtClosure.rowsCount();
    }
    // resets to the original state.
    reset() {
        this.eventsSubject.next();
        this._dtClosure.updateData(this.data);
    }
    destroy() {
        const { destroy } = this._dtClosure;
        if (destroy && typeof destroy === 'function') {
            try {
                destroy.call(this._dtClosure);
            }
            catch (err) {
                console.error('component not destroyed', err);
            }
        }
    }
    update(input) {
        this.checkIfInitialized();
        if (!input)
            throw new Error(this.CONSTANTS.INVALID_INPUT);
        const { config = {}, data = null } = input;
        const { columnConfig: columns, ...others } = config;
        if (data && this._dtClosure) {
            this._dtClosure.updateData(data);
        }
        this._setTableOptions({
            ...others,
            ...(data && { data }),
            ...(columns && { columns })
        });
    }
    ;
    addRows(data) {
        this.addData(data);
    }
    getRowAtIndex(index) {
        const { getRowAtIndex } = this._dtClosure;
        if (getRowAtIndex) {
            return getRowAtIndex.bind(this._dtClosure, index);
        }
    }
    async removeRow(index) {
        const data = await this._dtClosure.getData();
        data.splice(index, 1);
        await this._dtClosure.updateData(data);
    }
    addData(data) {
        const { addData } = this._dtClosure;
        if (addData && typeof addData === 'function') {
            try {
                addData.call(this._dtClosure, data);
            }
            catch (error) {
                console.error('addition of data failed', error);
            }
        }
    }
    _tableOpsClosure(tableInstance) {
        return {
            get instance() {
                return tableInstance;
            },
            async addData(data) {
                const instance = await this.instance;
                instance.row.add(data);
                instance.draw();
            },
            async draw() {
                const instance = await this.instance;
                instance.draw();
                return instance;
            },
            async destroy() {
                const instance = await this.instance;
                instance.destroy();
                return instance;
            },
            async updateData(data) {
                const instance = await this.instance;
                instance.clear();
                instance.rows.add(data);
                instance.draw();
            },
            async rowsCount() {
                const instance = await this.instance;
                return instance.rows().count();
            },
            async getData() {
                const instance = await this.instance;
                return instance.rows().data();
            },
            async getRowAtIndex(index) {
                const data = await this.getData();
                return data[index];
            }
        };
    }
    _getColumnsForStrictMode() {
        const columnsConfig = get(this.config, 'columnConfig');
        const columnsSortedByIndex = sortBy(columnsConfig, 'index');
        const omitHiddenColumns = omitBy(columnsSortedByIndex, col => get(col, 'visible') === false);
        return omitHiddenColumns;
    }
    // Returns the csv string for the mobile platform
    async exportCsv(options = {}) {
        let JSON = await this._dtClosure.getData();
        if (options && options['strict']) {
            const columnsConfig = this._getColumnsForStrictMode();
            const columnsToPick = map(columnsConfig, 'data');
            const headersMapping = map(columnsConfig, 'title');
            options['rename'] = headersMapping;
            JSON = this.sortAndTransformData(JSON || this.data, { columnsToPick });
        }
        return this.getCsv((JSON && JSON.toArray()) || this.data, options);
    }
    async exportAs(format, options = {}) {
        if (!this.exportOptions.includes(format)) {
            throw new Error('given type not supported');
        }
        const data = await this._dtClosure.getData();
        switch (format) {
            case 'csv': {
                if (options && options['strict']) {
                    const columnsConfig = this._getColumnsForStrictMode();
                    const headersMapping = map(columnsConfig, 'title');
                    const columnsToPick = map(columnsConfig, 'data');
                    options['rename'] = headersMapping;
                    options['columnsToPick'] = columnsToPick;
                }
                this.exportAsCsv(data && data.toArray(), options);
                break;
            }
        }
    }
}
DtTableComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.3.0", ngImport: i0, type: DtTableComponent, deps: [{ token: DATA_SERVICE }, { token: DEFAULT_CONFIG }, { token: DASHLET_CONSTANTS }], target: i0.ɵɵFactoryTarget.Component });
DtTableComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "14.3.0", type: DtTableComponent, selector: "sb-dt-table", providers: [
        {
            provide: DEFAULT_CONFIG,
            useValue: TABLE_DEFAULT_CONFIG
        }
    ], viewQueries: [{ propertyName: "dataTableElement", first: true, predicate: DataTableDirective, descendants: true }], usesInheritance: true, ngImport: i0, template: "<ng-template #defaultFilterTemplate let-context>\n  <sb-dashlets-filters [data]=\"context?.data\" [config]=\"context?.config?.filters\"\n    (filteredData)=\"update({data: $event})\"  [resetFilters]=\"eventsSubject.asObservable()\">\n  </sb-dashlets-filters>\n</ng-template>\n\n<ng-container *ngIf=\"$context?.config?.filters\" [ngTemplateOutlet]=\"templateRefs?.filter || defaultFilterTemplate\"\n  [ngTemplateOutletContext]=\"{'$implicit': $context}\">\n</ng-container>\n\n<ng-container *ngIf=\"templateRefs?.header && $context\" [ngTemplateOutlet]=\"templateRefs?.header\"\n  [ngTemplateOutletContext]=\"{'$implicit': $context}\">\n</ng-container>\n\n<ng-container *ngIf=\"$context?.inputParameters\">\n  <table datatable [dtOptions]=\"$context?.inputParameters\" class=\"row-border hover\"></table>\n</ng-container>\n\n<ng-container *ngIf=\"templateRefs?.footer && $context\" [ngTemplateOutlet]=\"templateRefs?.footer\"\n  [ngTemplateOutletContext]=\"{'$implicit': $context}\">\n</ng-container>", styles: [""], dependencies: [{ kind: "directive", type: i1.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "directive", type: i1.NgTemplateOutlet, selector: "[ngTemplateOutlet]", inputs: ["ngTemplateOutletContext", "ngTemplateOutlet", "ngTemplateOutletInjector"] }, { kind: "directive", type: i2.DataTableDirective, selector: "[datatable]", inputs: ["dtOptions", "dtTrigger"] }, { kind: "component", type: i3.FiltersComponent, selector: "sb-dashlets-filters", inputs: ["config", "data", "resetFilters"], outputs: ["filteredData"] }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.3.0", ngImport: i0, type: DtTableComponent, decorators: [{
            type: Component,
            args: [{ selector: 'sb-dt-table', providers: [
                        {
                            provide: DEFAULT_CONFIG,
                            useValue: TABLE_DEFAULT_CONFIG
                        }
                    ], template: "<ng-template #defaultFilterTemplate let-context>\n  <sb-dashlets-filters [data]=\"context?.data\" [config]=\"context?.config?.filters\"\n    (filteredData)=\"update({data: $event})\"  [resetFilters]=\"eventsSubject.asObservable()\">\n  </sb-dashlets-filters>\n</ng-template>\n\n<ng-container *ngIf=\"$context?.config?.filters\" [ngTemplateOutlet]=\"templateRefs?.filter || defaultFilterTemplate\"\n  [ngTemplateOutletContext]=\"{'$implicit': $context}\">\n</ng-container>\n\n<ng-container *ngIf=\"templateRefs?.header && $context\" [ngTemplateOutlet]=\"templateRefs?.header\"\n  [ngTemplateOutletContext]=\"{'$implicit': $context}\">\n</ng-container>\n\n<ng-container *ngIf=\"$context?.inputParameters\">\n  <table datatable [dtOptions]=\"$context?.inputParameters\" class=\"row-border hover\"></table>\n</ng-container>\n\n<ng-container *ngIf=\"templateRefs?.footer && $context\" [ngTemplateOutlet]=\"templateRefs?.footer\"\n  [ngTemplateOutletContext]=\"{'$implicit': $context}\">\n</ng-container>" }]
        }], ctorParameters: function () { return [{ type: undefined, decorators: [{
                    type: Inject,
                    args: [DATA_SERVICE]
                }] }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [DEFAULT_CONFIG]
                }] }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [DASHLET_CONSTANTS]
                }] }]; }, propDecorators: { dataTableElement: [{
                type: ViewChild,
                args: [DataTableDirective]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHQtdGFibGUuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvc2ItZGFzaGxldHMvc3JjL2xpYi9jb21wb25lbnRzL2R0LXRhYmxlL2R0LXRhYmxlLmNvbXBvbmVudC50cyIsIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3NiLWRhc2hsZXRzL3NyYy9saWIvY29tcG9uZW50cy9kdC10YWJsZS9kdC10YWJsZS5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFjLE1BQU0sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDekUsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDeEQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLFlBQVksRUFBRSxjQUFjLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNyRixPQUFPLEVBQUUsV0FBVyxFQUFnRCxXQUFXLEVBQWdCLE1BQU0sbUJBQW1CLENBQUM7QUFDekgsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzlELE9BQU8sS0FBSyxVQUFVLE1BQU0saUJBQWlCLENBQUM7QUFDOUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxNQUFNLFdBQVcsQ0FBQzs7Ozs7QUFETixNQUFNLFVBQVUsR0FBRyxVQUFVLENBQUM7QUFnQjdFLE1BQU0sT0FBTyxnQkFBaUIsU0FBUSxhQUFhO0lBZ0JqRCxZQUE0QyxXQUF5QixFQUEwQixhQUFhLEVBQXFDLFNBQXVCO1FBQ3RLLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUR1QixnQkFBVyxHQUFYLFdBQVcsQ0FBYztRQUE0RSxjQUFTLEdBQVQsU0FBUyxDQUFjO1FBWGpL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QUFDO29CQUNqRCxPQUFPLENBQUMsUUFBUSxDQUFDLEdBQUcsY0FBYyxDQUFDO29CQUNuQyxPQUFPLENBQUMsZUFBZSxDQUFDLEdBQUcsYUFBYSxDQUFDO2lCQUMxQztnQkFDRCxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsT0FBTyxFQUFFLEVBQUUsT0FBTyxDQUFDLENBQUM7Z0JBQ2xELE1BQU07YUFDUDtTQUNGO0lBQ0gsQ0FBQzs7NkdBbE5VLGdCQUFnQixrQkFnQlAsWUFBWSxhQUErQyxjQUFjLGFBQXlCLGlCQUFpQjtpR0FoQjVILGdCQUFnQixzQ0FQaEI7UUFDVDtZQUNFLE9BQU8sRUFBRSxjQUFjO1lBQ3ZCLFFBQVEsRUFBRSxvQkFBb0I7U0FDL0I7S0FDRiw0RUFhVSxrQkFBa0IsdUVDakMvQix3K0JBb0JlOzJGREVGLGdCQUFnQjtrQkFYNUIsU0FBUzsrQkFDRSxhQUFhLGFBR1o7d0JBQ1Q7NEJBQ0UsT0FBTyxFQUFFLGNBQWM7NEJBQ3ZCLFFBQVEsRUFBRSxvQkFBb0I7eUJBQy9CO3FCQUNGOzswQkFrQlksTUFBTTsyQkFBQyxZQUFZOzswQkFBd0MsTUFBTTsyQkFBQyxjQUFjOzswQkFBa0IsTUFBTTsyQkFBQyxpQkFBaUI7NENBTHBHLGdCQUFnQjtzQkFBbEQsU0FBUzt1QkFBQyxrQkFBa0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIEVsZW1lbnRSZWYsIEluamVjdCwgVmlld0NoaWxkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBEYXRhVGFibGVEaXJlY3RpdmUgfSBmcm9tICdhbmd1bGFyLWRhdGF0YWJsZXMnO1xuaW1wb3J0IHsgREFTSExFVF9DT05TVEFOVFMsIERBVEFfU0VSVklDRSwgREVGQVVMVF9DT05GSUcgfSBmcm9tICcuLi8uLi90b2tlbnMvaW5kZXgnO1xuaW1wb3J0IHsgSVJlcG9ydFR5cGUsIElucHV0UGFyYW1zLCBVcGRhdGVJbnB1dFBhcmFtcywgU3RyaW5nT2JqZWN0LCBSZXBvcnRTdGF0ZSwgSURhdGFTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vdHlwZXMvaW5kZXgnO1xuaW1wb3J0IHsgQmFzZUNvbXBvbmVudCB9IGZyb20gJy4uL2Jhc2UvYmFzZS5jb21wb25lbnQnO1xuaW1wb3J0IHsgVEFCTEVfREVGQVVMVF9DT05GSUcgfSBmcm9tICcuL2RlZmF1bHRDb25maWd1cmF0aW9uJztcbmltcG9ydCAqIGFzIGpzb25leHBvcnQgZnJvbSBcImpzb25leHBvcnQvZGlzdFwiOyBjb25zdCBqc29uRXhwb3J0ID0ganNvbmV4cG9ydDtcbmltcG9ydCB7IHNvcnRCeSwgbWFwLCBnZXQsIG9taXRCeSB9IGZyb20gJ2xvZGFzaC1lcyc7XG5cblxuZGVjbGFyZSB2YXIgJDtcbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ3NiLWR0LXRhYmxlJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2R0LXRhYmxlLmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vZHQtdGFibGUuY29tcG9uZW50LmNzcyddLFxuICBwcm92aWRlcnM6IFtcbiAgICB7XG4gICAgICBwcm92aWRlOiBERUZBVUxUX0NPTkZJRyxcbiAgICAgIHVzZVZhbHVlOiBUQUJMRV9ERUZBVUxUX0NPTkZJR1xuICAgIH1cbiAgXVxufSlcbmV4cG9ydCBjbGFzcyBEdFRhYmxlQ29tcG9uZW50IGV4dGVuZHMgQmFzZUNvbXBvbmVudCB7XG5cbiAgcHJpdmF0ZSBfZHRDbG9zdXJlOiBhbnk7XG5cbiAgICBcbiAgcHVibGljIHJlcG9ydFR5cGU6IElSZXBvcnRUeXBlID0gSVJlcG9ydFR5cGUuVEFCTEU7XG4gIHB1YmxpYyBjb25maWc6IG9iamVjdDtcbiAgcHVibGljIF9kZWZhdWx0Q29uZmlnOiBvYmplY3Q7XG4gIHB1YmxpYyBpbnB1dFBhcmFtZXRlcnMgPSB7fTtcbiAgcHVibGljIGV4cG9ydE9wdGlvbnMgPSBbJ2NzdiddO1xuXG4gIEBWaWV3Q2hpbGQoRGF0YVRhYmxlRGlyZWN0aXZlKSBzZXQgZGF0YVRhYmxlRWxlbWVudChlbGVtZW50OiBFbGVtZW50UmVmIHwgbnVsbCkge1xuICAgIGlmICghZWxlbWVudCkgcmV0dXJuO1xuICAgIHRoaXMuX2R0Q2xvc3VyZSA9IHRoaXMuX3RhYmxlT3BzQ2xvc3VyZShlbGVtZW50ICYmIGVsZW1lbnRbJ2R0SW5zdGFuY2UnXSk7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihASW5qZWN0KERBVEFfU0VSVklDRSkgcHJvdGVjdGVkIGRhdGFTZXJ2aWNlOiBJRGF0YVNlcnZpY2UsIEBJbmplY3QoREVGQVVMVF9DT05GSUcpIGRlZmF1bHRDb25maWcsIEBJbmplY3QoREFTSExFVF9DT05TVEFOVFMpIHByaXZhdGUgQ09OU1RBTlRTOiBTdHJpbmdPYmplY3QpIHtcbiAgICBzdXBlcihkYXRhU2VydmljZSk7XG4gICAgdGhpcy5fZGVmYXVsdENvbmZpZyA9IGRlZmF1bHRDb25maWc7XG4gIH1cblxuICBhc3luYyBpbml0aWFsaXplKHsgY29uZmlnLCB0eXBlLCBkYXRhIH06IElucHV0UGFyYW1zKTogUHJvbWlzZTxhbnk+IHtcbiAgICBpZiAoIShjb25maWcgJiYgdHlwZSAmJiBkYXRhKSkgdGhyb3cgbmV3IFN5bnRheEVycm9yKHRoaXMuQ09OU1RBTlRTLklOVkFMSURfSU5QVVQpO1xuICAgIHRoaXMuY29uZmlnID0gY29uZmlnID0geyAuLi5jb25maWcsIHR5cGUgfTtcbiAgICBjb25zdCBmZXRjaGVkSlNPTiA9IHRoaXMuZGF0YSA9IGF3YWl0IHRoaXMuZmV0Y2hEYXRhKGRhdGEpLnRvUHJvbWlzZSgpLmNhdGNoKGVyciA9PiBbXSk7XG4gICAgdGhpcy5idWlsZGVyKGNvbmZpZywgZmV0Y2hlZEpTT04pO1xuICAgIHRoaXMuX2lzSW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgIHRoaXMuc3RhdGUuZW1pdChSZXBvcnRTdGF0ZS5ET05FKTtcbiAgfVxuXG4gIHByaXZhdGUgcm93Q2xpY2tIYW5kbGVyID0gKHJvdzogTm9kZSwgZGF0YTogYW55W10gfCBPYmplY3QsIGluZGV4OiBudW1iZXIpID0+IHtcbiAgICBjb25zdCBzZWxmID0gdGhpcztcbiAgICAkKCd0ZCcsIHJvdykub2ZmKCdjbGljaycpO1xuICAgICQoJ3RkJywgcm93KS5vbignY2xpY2snLCAoKSA9PiB7XG4gICAgICB0aGlzLmV2ZW50cy5lbWl0KHtcbiAgICAgICAgdHlwZTogJ0NMSUNLJyxcbiAgICAgICAgZXZlbnQ6IGRhdGFcbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIHJldHVybiByb3c7XG4gIH1cblxuICBwcml2YXRlIF9hZGREZWZhdWx0VG9Db2x1bW4gPSBjb2x1bW4gPT4ge1xuICAgIHJldHVybiB7IC4uLnRoaXMuX2RlZmF1bHRDb25maWdbJ2NvbHVtbkNvbmZpZyddLCAuLi5jb2x1bW4gfTtcbiAgfVxuXG4gIGJ1aWxkZXIoY29uZmlnLCBkYXRhKSB7XG4gICAgY29uc3QgeyBjb2x1bW5Db25maWcsIC4uLm90aGVycyB9ID0gY29uZmlnO1xuICAgIGNvbnN0IGNvbHVtbnMgPSBjb2x1bW5Db25maWcubWFwKHRoaXMuX2FkZERlZmF1bHRUb0NvbHVtbik7XG4gICAgY29uc3QgY29sdW1uc1NvcnRlZEJ5SW5kZXggPSBzb3J0QnkoY29sdW1ucywgWydpbmRleCddKTtcbiAgICB0aGlzLl9zZXRUYWJsZU9wdGlvbnMoe1xuICAgICAgLi4ub3RoZXJzLFxuICAgICAgZGF0YSxcbiAgICAgIGNvbHVtbnM6IGNvbHVtbnNTb3J0ZWRCeUluZGV4LFxuICAgICAgcm93Q2FsbGJhY2s6IHRoaXMucm93Q2xpY2tIYW5kbGVyLmJpbmQodGhpcylcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgX3NldFRhYmxlT3B0aW9ucyhjb25maWc6IG9iamVjdCA9IHt9KSB7XG4gICAgdGhpcy5pbnB1dFBhcmFtZXRlcnMgPSB7XG4gICAgICAuLi50aGlzLl9kZWZhdWx0Q29uZmlnWyd0YWJsZUxldmVsQ29uZmlnJ10sXG4gICAgICAuLi50aGlzLmlucHV0UGFyYW1ldGVycyxcbiAgICAgIC4uLmNvbmZpZ1xuICAgIH1cbiAgICB0aGlzLiRjb250ZXh0ID0geyBkYXRhOiB0aGlzLmRhdGEsIGNvbmZpZzogdGhpcy5jb25maWcsIGlucHV0UGFyYW1ldGVyczogdGhpcy5pbnB1dFBhcmFtZXRlcnMsIGV4cG9ydE9wdGlvbnM6IHRoaXMuZXhwb3J0T3B0aW9ucyxyZXNldDpmYWxzZSB9O1xuICB9XG5cbiAgZ2V0Um93c0NvdW50KCk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgcmV0dXJuIHRoaXMuX2R0Q2xvc3VyZSAmJiB0aGlzLl9kdENsb3N1cmUucm93c0NvdW50KCk7XG4gIH1cblxuICAvLyByZXNldHMgdG8gdGhlIG9yaWdpbmFsIHN0YXRlLlxuICByZXNldCgpOiB2b2lkIHtcbiAgICAgIHRoaXMuZXZlbnRzU3ViamVjdC5uZXh0KCk7XG4gICAgICB0aGlzLl9kdENsb3N1cmUudXBkYXRlRGF0YSh0aGlzLmRhdGEpO1xuICB9XG5cbiAgZGVzdHJveSgpOiB2b2lkIHtcbiAgICBjb25zdCB7IGRlc3Ryb3kgfSA9IHRoaXMuX2R0Q2xvc3VyZTtcbiAgICBpZiAoZGVzdHJveSAmJiB0eXBlb2YgZGVzdHJveSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgZGVzdHJveS5jYWxsKHRoaXMuX2R0Q2xvc3VyZSk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcignY29tcG9uZW50IG5vdCBkZXN0cm95ZWQnLCBlcnIpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHVwZGF0ZShpbnB1dDogUGFydGlhbDxVcGRhdGVJbnB1dFBhcmFtcz4pIHtcbiAgICB0aGlzLmNoZWNrSWZJbml0aWFsaXplZCgpO1xuICAgIGlmICghaW5wdXQpIHRocm93IG5ldyBFcnJvcih0aGlzLkNPTlNUQU5UUy5JTlZBTElEX0lOUFVUKTtcbiAgICBjb25zdCB7IGNvbmZpZyA9IHt9LCBkYXRhID0gbnVsbCB9ID0gaW5wdXQ7XG4gICAgY29uc3QgeyBjb2x1bW5Db25maWc6IGNvbHVtbnMsIC4uLm90aGVycyB9ID0gY29uZmlnIGFzIGFueTtcbiAgICBpZiAoZGF0YSAmJiB0aGlzLl9kdENsb3N1cmUpIHtcbiAgICAgIHRoaXMuX2R0Q2xvc3VyZS51cGRhdGVEYXRhKGRhdGEpO1xuICAgIH1cbiAgICB0aGlzLl9zZXRUYWJsZU9wdGlvbnMoe1xuICAgICAgLi4ub3RoZXJzLFxuICAgICAgLi4uKGRhdGEgJiYgeyBkYXRhIH0pLFxuICAgICAgLi4uKGNvbHVtbnMgJiYgeyBjb2x1bW5zIH0pXG4gICAgfSk7XG4gIH07XG5cbiAgYWRkUm93cyhkYXRhOiBvYmplY3QgfCBvYmplY3RbXSk6IHZvaWQge1xuICAgIHRoaXMuYWRkRGF0YShkYXRhKTtcbiAgfVxuXG4gIGdldFJvd0F0SW5kZXgoaW5kZXgpOiBQcm9taXNlPGFueT4ge1xuICAgIGNvbnN0IHsgZ2V0Um93QXRJbmRleCB9ID0gdGhpcy5fZHRDbG9zdXJlO1xuICAgIGlmIChnZXRSb3dBdEluZGV4KSB7XG4gICAgICByZXR1cm4gZ2V0Um93QXRJbmRleC5iaW5kKHRoaXMuX2R0Q2xvc3VyZSwgaW5kZXgpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHJlbW92ZVJvdyhpbmRleDogbnVtYmVyKSB7XG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHRoaXMuX2R0Q2xvc3VyZS5nZXREYXRhKCk7XG4gICAgZGF0YS5zcGxpY2UoaW5kZXgsIDEpO1xuICAgIGF3YWl0IHRoaXMuX2R0Q2xvc3VyZS51cGRhdGVEYXRhKGRhdGEpO1xuICB9XG5cbiAgYWRkRGF0YShkYXRhOiBvYmplY3QgfCBvYmplY3RbXSk6IHZvaWQge1xuICAgIGNvbnN0IHsgYWRkRGF0YSB9ID0gdGhpcy5fZHRDbG9zdXJlO1xuICAgIGlmIChhZGREYXRhICYmIHR5cGVvZiBhZGREYXRhID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICB0cnkge1xuICAgICAgICBhZGREYXRhLmNhbGwodGhpcy5fZHRDbG9zdXJlLCBkYXRhKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ2FkZGl0aW9uIG9mIGRhdGEgZmFpbGVkJywgZXJyb3IpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX3RhYmxlT3BzQ2xvc3VyZSh0YWJsZUluc3RhbmNlKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGdldCBpbnN0YW5jZSgpIHtcbiAgICAgICAgcmV0dXJuIHRhYmxlSW5zdGFuY2U7XG4gICAgICB9LFxuICAgICAgYXN5bmMgYWRkRGF0YShkYXRhOiBvYmplY3QgfCBvYmplY3RbXSkge1xuICAgICAgICBjb25zdCBpbnN0YW5jZSA9IGF3YWl0IHRoaXMuaW5zdGFuY2U7XG4gICAgICAgIGluc3RhbmNlLnJvdy5hZGQoZGF0YSk7XG4gICAgICAgIGluc3RhbmNlLmRyYXcoKTtcbiAgICAgIH0sXG4gICAgICBhc3luYyBkcmF3KCkge1xuICAgICAgICBjb25zdCBpbnN0YW5jZSA9IGF3YWl0IHRoaXMuaW5zdGFuY2U7XG4gICAgICAgIGluc3RhbmNlLmRyYXcoKTtcbiAgICAgICAgcmV0dXJuIGluc3RhbmNlO1xuICAgICAgfSxcbiAgICAgIGFzeW5jIGRlc3Ryb3koKSB7XG4gICAgICAgIGNvbnN0IGluc3RhbmNlID0gYXdhaXQgdGhpcy5pbnN0YW5jZTtcbiAgICAgICAgaW5zdGFuY2UuZGVzdHJveSgpO1xuICAgICAgICByZXR1cm4gaW5zdGFuY2U7XG4gICAgICB9LFxuICAgICAgYXN5bmMgdXBkYXRlRGF0YShkYXRhKSB7XG4gICAgICAgIGNvbnN0IGluc3RhbmNlID0gYXdhaXQgdGhpcy5pbnN0YW5jZTtcbiAgICAgICAgaW5zdGFuY2UuY2xlYXIoKTtcbiAgICAgICAgaW5zdGFuY2Uucm93cy5hZGQoZGF0YSk7XG4gICAgICAgIGluc3RhbmNlLmRyYXcoKTtcbiAgICAgIH0sXG4gICAgICBhc3luYyByb3dzQ291bnQoKSB7XG4gICAgICAgIGNvbnN0IGluc3RhbmNlID0gYXdhaXQgdGhpcy5pbnN0YW5jZTtcbiAgICAgICAgcmV0dXJuIGluc3RhbmNlLnJvd3MoKS5jb3VudCgpO1xuICAgICAgfSxcbiAgICAgIGFzeW5jIGdldERhdGEoKSB7XG4gICAgICAgIGNvbnN0IGluc3RhbmNlID0gYXdhaXQgdGhpcy5pbnN0YW5jZTtcbiAgICAgICAgcmV0dXJuIGluc3RhbmNlLnJvd3MoKS5kYXRhKCk7XG4gICAgICB9LFxuICAgICAgYXN5bmMgZ2V0Um93QXRJbmRleChpbmRleDogbnVtYmVyKSB7XG4gICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCB0aGlzLmdldERhdGEoKTtcbiAgICAgICAgcmV0dXJuIGRhdGFbaW5kZXhdO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX2dldENvbHVtbnNGb3JTdHJpY3RNb2RlKCkge1xuICAgIGNvbnN0IGNvbHVtbnNDb25maWcgPSBnZXQodGhpcy5jb25maWcsICdjb2x1bW5Db25maWcnKTtcbiAgICBjb25zdCBjb2x1bW5zU29ydGVkQnlJbmRleCA9IHNvcnRCeShjb2x1bW5zQ29uZmlnLCAnaW5kZXgnKTtcbiAgICBjb25zdCBvbWl0SGlkZGVuQ29sdW1ucyA9IG9taXRCeShjb2x1bW5zU29ydGVkQnlJbmRleCwgY29sID0+IGdldChjb2wsICd2aXNpYmxlJykgPT09IGZhbHNlKTtcbiAgICByZXR1cm4gb21pdEhpZGRlbkNvbHVtbnM7XG4gIH1cblxuICAvLyBSZXR1cm5zIHRoZSBjc3Ygc3RyaW5nIGZvciB0aGUgbW9iaWxlIHBsYXRmb3JtXG4gIGFzeW5jIGV4cG9ydENzdihvcHRpb25zID0ge30pIHtcbiAgICBsZXQgSlNPTiA9IGF3YWl0IHRoaXMuX2R0Q2xvc3VyZS5nZXREYXRhKCk7XG4gICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9uc1snc3RyaWN0J10pIHtcbiAgICAgIGNvbnN0IGNvbHVtbnNDb25maWcgPSB0aGlzLl9nZXRDb2x1bW5zRm9yU3RyaWN0TW9kZSgpO1xuICAgICAgY29uc3QgY29sdW1uc1RvUGljayA9IG1hcChjb2x1bW5zQ29uZmlnLCAnZGF0YScpO1xuICAgICAgY29uc3QgaGVhZGVyc01hcHBpbmcgPSBtYXAoY29sdW1uc0NvbmZpZywgJ3RpdGxlJyk7XG4gICAgICBvcHRpb25zWydyZW5hbWUnXSA9IGhlYWRlcnNNYXBwaW5nO1xuICAgICAgSlNPTiA9IHRoaXMuc29ydEFuZFRyYW5zZm9ybURhdGEoSlNPTiB8fCB0aGlzLmRhdGEsIHsgY29sdW1uc1RvUGljayB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuZ2V0Q3N2KChKU09OICYmIEpTT04udG9BcnJheSgpKSB8fCB0aGlzLmRhdGEsIG9wdGlvbnMpO1xuICB9XG5cbiAgYXN5bmMgZXhwb3J0QXMoZm9ybWF0OiBzdHJpbmcsIG9wdGlvbnMgPSB7fSkge1xuICAgIGlmICghdGhpcy5leHBvcnRPcHRpb25zLmluY2x1ZGVzKGZvcm1hdCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignZ2l2ZW4gdHlwZSBub3Qgc3VwcG9ydGVkJyk7XG4gICAgfVxuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCB0aGlzLl9kdENsb3N1cmUuZ2V0RGF0YSgpO1xuICAgIHN3aXRjaCAoZm9ybWF0KSB7XG4gICAgICBjYXNlICdjc3YnOiB7XG4gICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnNbJ3N0cmljdCddKSB7XG4gICAgICAgICAgY29uc3QgY29sdW1uc0NvbmZpZyA9IHRoaXMuX2dldENvbHVtbnNGb3JTdHJpY3RNb2RlKClcbiAgICAgICAgICBjb25zdCBoZWFkZXJzTWFwcGluZyA9IG1hcChjb2x1bW5zQ29uZmlnLCAndGl0bGUnKTtcbiAgICAgICAgICBjb25zdCBjb2x1bW5zVG9QaWNrID0gbWFwKGNvbHVtbnNDb25maWcsICdkYXRhJyk7XG4gICAgICAgICAgb3B0aW9uc1sncmVuYW1lJ10gPSBoZWFkZXJzTWFwcGluZztcbiAgICAgICAgICBvcHRpb25zWydjb2x1bW5zVG9QaWNrJ10gPSBjb2x1bW5zVG9QaWNrO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZXhwb3J0QXNDc3YoZGF0YSAmJiBkYXRhLnRvQXJyYXkoKSwgb3B0aW9ucyk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuIiwiPG5nLXRlbXBsYXRlICNkZWZhdWx0RmlsdGVyVGVtcGxhdGUgbGV0LWNvbnRleHQ+XG4gIDxzYi1kYXNobGV0cy1maWx0ZXJzIFtkYXRhXT1cImNvbnRleHQ/LmRhdGFcIiBbY29uZmlnXT1cImNvbnRleHQ/LmNvbmZpZz8uZmlsdGVyc1wiXG4gICAgKGZpbHRlcmVkRGF0YSk9XCJ1cGRhdGUoe2RhdGE6ICRldmVudH0pXCIgIFtyZXNldEZpbHRlcnNdPVwiZXZlbnRzU3ViamVjdC5hc09ic2VydmFibGUoKVwiPlxuICA8L3NiLWRhc2hsZXRzLWZpbHRlcnM+XG48L25nLXRlbXBsYXRlPlxuXG48bmctY29udGFpbmVyICpuZ0lmPVwiJGNvbnRleHQ/LmNvbmZpZz8uZmlsdGVyc1wiIFtuZ1RlbXBsYXRlT3V0bGV0XT1cInRlbXBsYXRlUmVmcz8uZmlsdGVyIHx8IGRlZmF1bHRGaWx0ZXJUZW1wbGF0ZVwiXG4gIFtuZ1RlbXBsYXRlT3V0bGV0Q29udGV4dF09XCJ7JyRpbXBsaWNpdCc6ICRjb250ZXh0fVwiPlxuPC9uZy1jb250YWluZXI+XG5cbjxuZy1jb250YWluZXIgKm5nSWY9XCJ0ZW1wbGF0ZVJlZnM/LmhlYWRlciAmJiAkY29udGV4dFwiIFtuZ1RlbXBsYXRlT3V0bGV0XT1cInRlbXBsYXRlUmVmcz8uaGVhZGVyXCJcbiAgW25nVGVtcGxhdGVPdXRsZXRDb250ZXh0XT1cInsnJGltcGxpY2l0JzogJGNvbnRleHR9XCI+XG48L25nLWNvbnRhaW5lcj5cblxuPG5nLWNvbnRhaW5lciAqbmdJZj1cIiRjb250ZXh0Py5pbnB1dFBhcmFtZXRlcnNcIj5cbiAgPHRhYmxlIGRhdGF0YWJsZSBbZHRPcHRpb25zXT1cIiRjb250ZXh0Py5pbnB1dFBhcmFtZXRlcnNcIiBjbGFzcz1cInJvdy1ib3JkZXIgaG92ZXJcIj48L3RhYmxlPlxuPC9uZy1jb250YWluZXI+XG5cbjxuZy1jb250YWluZXIgKm5nSWY9XCJ0ZW1wbGF0ZVJlZnM/LmZvb3RlciAmJiAkY29udGV4dFwiIFtuZ1RlbXBsYXRlT3V0bGV0XT1cInRlbXBsYXRlUmVmcz8uZm9vdGVyXCJcbiAgW25nVGVtcGxhdGVPdXRsZXRDb250ZXh0XT1cInsnJGltcGxpY2l0JzogJGNvbnRleHR9XCI+XG48L25nLWNvbnRhaW5lcj4iXX0=