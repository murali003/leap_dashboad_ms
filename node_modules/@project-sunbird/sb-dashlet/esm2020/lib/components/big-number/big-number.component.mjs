import { Component, Inject } from '@angular/core';
import { IReportType, ChartType, ReportState } from '../../types/index';
import { BaseComponent } from '../base/base.component';
import { DEFAULT_CONFIG as DEFAULT_CONFIG_TOKEN, DASHLET_CONSTANTS, DATA_SERVICE } from '../../tokens/index';
import { runAggregator } from './operations';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
import * as i2 from "../filters/filters.component";
export class BigNumberComponent extends BaseComponent {
    constructor(dataService, defaultConfig, cdr, CONSTANTS) {
        super(dataService);
        this.dataService = dataService;
        this.cdr = cdr;
        this.CONSTANTS = CONSTANTS;
        this.reportType = IReportType.CHART;
        this.type = ChartType.BIG_NUMBER;
        this.inputParameters = {};
        this.exportOptions = ['csv'];
        this.bigNumberDataClosure = (dataExpr) => $aggregateFn => (data) => {
            return {
                getData(overriddenData) {
                    data = overriddenData || data;
                    return runAggregator($aggregateFn, data, dataExpr);
                },
                addData(newData) {
                    data = data.concat(newData);
                    return this.getData();
                }
            };
        };
        this._defaultConfig = defaultConfig;
    }
    async initialize({ config, data, type = "bigNumber" }) {
        if (!(config && data))
            throw new SyntaxError(this.CONSTANTS.INVALID_INPUT);
        this.config = config = { ...config, type };
        const fetchedJSON = this.data = await this.fetchData(data).toPromise().catch(err => []);
        this.builder(config, fetchedJSON);
        this._isInitialized = true;
        this.state.emit(ReportState.DONE);
    }
    builder(config, JSONData) {
        const { header = this._defaultConfig.header, footer = this._defaultConfig.footer, dataExpr, operation = this._defaultConfig.operation } = config;
        if (!dataExpr || !JSONData) {
            throw Error(this.CONSTANTS.INVALID_INPUT);
        }
        this._bigNumberClosure = this.bigNumberDataClosure(dataExpr)(operation)(JSONData);
        const bigNumberObj = { header, footer, data: this._bigNumberClosure.getData() };
        this.setBigNumberData(bigNumberObj);
    }
    setBigNumberData(config = {}) {
        this.inputParameters = { ...this._defaultConfig, ...this.inputParameters, ...config };
        this.$context = { data: this.data, config: this.config, inputParameters: this.inputParameters, exportOptions: this.exportOptions };
        this.cdr.detectChanges();
    }
    reset() {
        this.eventsSubject.next();
    }
    destroy() {
        throw new Error(this.CONSTANTS.METHOD_NOT_IMPLEMENTED);
    }
    update(input) {
        this.checkIfInitialized();
        if (!input)
            throw new Error(this.CONSTANTS.INVALID_INPUT);
        const { config = {}, data = null } = input;
        const { header, footer, dataExpr, operation = 'SUM' } = config;
        let bigNumber;
        if (data) {
            this._bigNumberClosure = (dataExpr && this.bigNumberDataClosure(dataExpr)(operation)(data)) || this._bigNumberClosure;
            bigNumber = this._bigNumberClosure.getData(data);
        }
        this.setBigNumberData({
            ...(header && { header }),
            ...(footer && { footer }),
            ...(bigNumber && {
                data: bigNumber
            })
        });
    }
    addData(data) {
        if (!data)
            throw new Error(this.CONSTANTS.INVALID_INPUT);
        data = Array.isArray(data) ? data : [data];
        const bigNumber = this._bigNumberClosure.addData(data);
        this.setBigNumberData({
            data: bigNumber
        });
    }
    refreshChart() {
        throw new Error(this.CONSTANTS.METHOD_NOT_IMPLEMENTED);
    }
    getTelemetry() {
        throw new Error(this.CONSTANTS.METHOD_NOT_IMPLEMENTED);
    }
    exportAs(format) {
        if (!this.exportOptions.includes(format)) {
            throw new Error('given type not supported');
        }
        this.exportAsCsv();
    }
}
BigNumberComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.3.0", ngImport: i0, type: BigNumberComponent, deps: [{ token: DATA_SERVICE }, { token: DEFAULT_CONFIG_TOKEN }, { token: i0.ChangeDetectorRef }, { token: DASHLET_CONSTANTS }], target: i0.ɵɵFactoryTarget.Component });
BigNumberComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "14.3.0", type: BigNumberComponent, selector: "sb-big-number", providers: [
        {
            provide: DEFAULT_CONFIG_TOKEN,
            useValue: {
                header: '',
                footer: '',
                operation: 'SUM'
            }
        }
    ], usesInheritance: true, ngImport: i0, template: "<ng-template #defaultTemplate let-config>\n  <div class=\"ui cards\">\n    <div class=\"card\">\n      <div class=\"content\">\n        <div class=\"header\">{{config?.inputParameters?.header}}</div>\n        <div class=\"meta\">{{config?.inputParameters?.footer}}</div>\n        <div class=\"description\">\n          {{config?.inputParameters?.data}}\n        </div>\n      </div>\n    </div>\n  </div>\n</ng-template>\n\n<ng-template #defaultFilterTemplate let-context>\n  <sb-dashlets-filters [data]=\"context?.data\" [config]=\"context?.config?.filters\"\n    (filteredData)=\"update({data: $event})\" [resetFilters]=\"eventsSubject.asObservable()\">\n  </sb-dashlets-filters>\n</ng-template>\n\n<ng-container *ngIf=\"$context?.config?.filters\" [ngTemplateOutlet]=\"templateRefs?.filter || defaultFilterTemplate\"\n  [ngTemplateOutletContext]=\"{'$implicit': $context}\">\n</ng-container>\n\n\n<ng-container *ngIf=\"templateRefs?.header && $context\" [ngTemplateOutlet]=\"templateRefs?.header\"\n  [ngTemplateOutletContext]=\"{'$implicit': $context}\">\n</ng-container>\n\n<ng-container *ngIf=\"$context\" [ngTemplateOutlet]=\"templateRefs?.body || defaultTemplate\"\n  [ngTemplateOutletContext]=\"{'$implicit': $context}\">\n</ng-container>\n\n<ng-container *ngIf=\"templateRefs?.footer && $context\" [ngTemplateOutlet]=\"templateRefs?.footer\"\n  [ngTemplateOutletContext]=\"{'$implicit': $context}\">\n</ng-container>", styles: [""], dependencies: [{ kind: "directive", type: i1.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "directive", type: i1.NgTemplateOutlet, selector: "[ngTemplateOutlet]", inputs: ["ngTemplateOutletContext", "ngTemplateOutlet", "ngTemplateOutletInjector"] }, { kind: "component", type: i2.FiltersComponent, selector: "sb-dashlets-filters", inputs: ["config", "data", "resetFilters"], outputs: ["filteredData"] }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.3.0", ngImport: i0, type: BigNumberComponent, decorators: [{
            type: Component,
            args: [{ selector: 'sb-big-number', providers: [
                        {
                            provide: DEFAULT_CONFIG_TOKEN,
                            useValue: {
                                header: '',
                                footer: '',
                                operation: 'SUM'
                            }
                        }
                    ], template: "<ng-template #defaultTemplate let-config>\n  <div class=\"ui cards\">\n    <div class=\"card\">\n      <div class=\"content\">\n        <div class=\"header\">{{config?.inputParameters?.header}}</div>\n        <div class=\"meta\">{{config?.inputParameters?.footer}}</div>\n        <div class=\"description\">\n          {{config?.inputParameters?.data}}\n        </div>\n      </div>\n    </div>\n  </div>\n</ng-template>\n\n<ng-template #defaultFilterTemplate let-context>\n  <sb-dashlets-filters [data]=\"context?.data\" [config]=\"context?.config?.filters\"\n    (filteredData)=\"update({data: $event})\" [resetFilters]=\"eventsSubject.asObservable()\">\n  </sb-dashlets-filters>\n</ng-template>\n\n<ng-container *ngIf=\"$context?.config?.filters\" [ngTemplateOutlet]=\"templateRefs?.filter || defaultFilterTemplate\"\n  [ngTemplateOutletContext]=\"{'$implicit': $context}\">\n</ng-container>\n\n\n<ng-container *ngIf=\"templateRefs?.header && $context\" [ngTemplateOutlet]=\"templateRefs?.header\"\n  [ngTemplateOutletContext]=\"{'$implicit': $context}\">\n</ng-container>\n\n<ng-container *ngIf=\"$context\" [ngTemplateOutlet]=\"templateRefs?.body || defaultTemplate\"\n  [ngTemplateOutletContext]=\"{'$implicit': $context}\">\n</ng-container>\n\n<ng-container *ngIf=\"templateRefs?.footer && $context\" [ngTemplateOutlet]=\"templateRefs?.footer\"\n  [ngTemplateOutletContext]=\"{'$implicit': $context}\">\n</ng-container>" }]
        }], ctorParameters: function () { return [{ type: undefined, decorators: [{
                    type: Inject,
                    args: [DATA_SERVICE]
                }] }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [DEFAULT_CONFIG_TOKEN]
                }] }, { type: i0.ChangeDetectorRef }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [DASHLET_CONSTANTS]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmlnLW51bWJlci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9zYi1kYXNobGV0cy9zcmMvbGliL2NvbXBvbmVudHMvYmlnLW51bWJlci9iaWctbnVtYmVyLmNvbXBvbmVudC50cyIsIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3NiLWRhc2hsZXRzL3NyYy9saWIvY29tcG9uZW50cy9iaWctbnVtYmVyL2JpZy1udW1iZXIuY29tcG9uZW50Lmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFxQixTQUFTLEVBQUUsTUFBTSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ3BFLE9BQU8sRUFBRSxXQUFXLEVBQTZDLFNBQVMsRUFBbUMsV0FBVyxFQUFnQixNQUFNLG1CQUFtQixDQUFDO0FBQ2xLLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUN2RCxPQUFPLEVBQUUsY0FBYyxJQUFJLG9CQUFvQixFQUFFLGlCQUFpQixFQUFFLFlBQVksRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQzdHLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxjQUFjLENBQUM7Ozs7QUFnQjdDLE1BQU0sT0FBTyxrQkFBbUIsU0FBUSxhQUFhO0lBV25ELFlBQTRDLFdBQXlCLEVBQWdDLGFBQStCLEVBQVUsR0FBc0IsRUFBcUMsU0FBdUI7UUFDOU4sS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRHVCLGdCQUFXLEdBQVgsV0FBVyxDQUFjO1FBQXlFLFFBQUcsR0FBSCxHQUFHLENBQW1CO1FBQXFDLGNBQVMsR0FBVCxTQUFTLENBQWM7UUFSek4sZUFBVSxHQUFnQixXQUFXLENBQUMsS0FBSyxDQUFDO1FBQzVDLFNBQUksR0FBYyxTQUFTLENBQUMsVUFBVSxDQUFDO1FBRXZDLG9CQUFlLEdBQXFCLEVBQUUsQ0FBQztRQUN2QyxrQkFBYSxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7UUFrQ3ZCLHlCQUFvQixHQUFHLENBQUMsUUFBZ0IsRUFBRSxFQUFFLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQWMsRUFBRSxFQUFFO1lBQ3RGLE9BQU87Z0JBQ0wsT0FBTyxDQUFDLGNBQXlCO29CQUMvQixJQUFJLEdBQUcsY0FBYyxJQUFJLElBQUksQ0FBQztvQkFDOUIsT0FBTyxhQUFhLENBQUMsWUFBWSxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztnQkFDckQsQ0FBQztnQkFDRCxPQUFPLENBQUMsT0FBaUI7b0JBQ3ZCLElBQUksR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO29CQUM1QixPQUFPLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztnQkFDeEIsQ0FBQzthQUNGLENBQUE7UUFDSCxDQUFDLENBQUE7UUF2Q0MsSUFBSSxDQUFDLGNBQWMsR0FBRyxhQUFhLENBQUM7SUFDdEMsQ0FBQztJQUVELEtBQUssQ0FBQyxVQUFVLENBQUMsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUksR0FBRyxXQUFXLEVBQWU7UUFDaEUsSUFBSSxDQUFDLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQztZQUFFLE1BQU0sSUFBSSxXQUFXLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUMzRSxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sR0FBRyxFQUFFLEdBQUcsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDO1FBQzNDLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxJQUFJLEdBQUcsTUFBTSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLFNBQVMsRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3hGLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBMEIsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUN0RCxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQztRQUMzQixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUVELE9BQU8sQ0FBQyxNQUF3QixFQUFFLFFBQVE7UUFDeEMsTUFBTSxFQUFFLE1BQU0sR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sRUFBRSxNQUFNLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLFNBQVMsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLFNBQVMsRUFBRSxHQUFHLE1BQU0sQ0FBQztRQUNqSixJQUFJLENBQUMsUUFBUSxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQzFCLE1BQU0sS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLENBQUM7U0FDM0M7UUFDRCxJQUFJLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFFBQVEsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ2xGLE1BQU0sWUFBWSxHQUFHLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUE7UUFDL0UsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQ3RDLENBQUM7SUFFTyxnQkFBZ0IsQ0FBQyxTQUFpQixFQUFFO1FBQzFDLElBQUksQ0FBQyxlQUFlLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxjQUFjLEVBQUUsR0FBRyxJQUFJLENBQUMsZUFBZSxFQUFFLEdBQUcsTUFBTSxFQUFFLENBQUM7UUFDdEYsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFFLGVBQWUsRUFBRSxJQUFJLENBQUMsZUFBZSxFQUFFLGFBQWEsRUFBRSxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUE7UUFDbEksSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUMzQixDQUFDO0lBZUQsS0FBSztRQUNILElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDNUIsQ0FBQztJQUVELE9BQU87UUFDTCxNQUFNLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsc0JBQXNCLENBQUMsQ0FBQztJQUN6RCxDQUFDO0lBRUQsTUFBTSxDQUFDLEtBQWlDO1FBQ3RDLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1FBQzFCLElBQUksQ0FBQyxLQUFLO1lBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQzFELE1BQU0sRUFBRSxNQUFNLEdBQUcsRUFBRSxFQUFFLElBQUksR0FBRyxJQUFJLEVBQUUsR0FBRyxLQUFLLENBQUM7UUFDM0MsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLFNBQVMsR0FBRyxLQUFLLEVBQUUsR0FBRyxNQUEwQixDQUFDO1FBQ25GLElBQUksU0FBUyxDQUFDO1FBQ2QsSUFBSSxJQUFJLEVBQUU7WUFDUixJQUFJLENBQUMsaUJBQWlCLEdBQUcsQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDLG9CQUFvQixDQUFDLFFBQVEsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLGlCQUFpQixDQUFDO1lBQ3RILFNBQVMsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ2xEO1FBQ0QsSUFBSSxDQUFDLGdCQUFnQixDQUFDO1lBQ3BCLEdBQUcsQ0FBQyxNQUFNLElBQUksRUFBRSxNQUFNLEVBQUUsQ0FBQztZQUN6QixHQUFHLENBQUMsTUFBTSxJQUFJLEVBQUUsTUFBTSxFQUFFLENBQUM7WUFDekIsR0FBRyxDQUFDLFNBQVMsSUFBSTtnQkFDZixJQUFJLEVBQUUsU0FBUzthQUNoQixDQUFDO1NBQ0gsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUVELE9BQU8sQ0FBQyxJQUF1QjtRQUM3QixJQUFJLENBQUMsSUFBSTtZQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUN6RCxJQUFJLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzNDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdkQsSUFBSSxDQUFDLGdCQUFnQixDQUFDO1lBQ3BCLElBQUksRUFBRSxTQUFTO1NBQ2hCLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxZQUFZO1FBQ1YsTUFBTSxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLHNCQUFzQixDQUFDLENBQUM7SUFDekQsQ0FBQztJQUVELFlBQVk7UUFDVixNQUFNLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsc0JBQXNCLENBQUMsQ0FBQztJQUN6RCxDQUFDO0lBRUQsUUFBUSxDQUFDLE1BQWM7UUFDckIsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ3hDLE1BQU0sSUFBSSxLQUFLLENBQUMsMEJBQTBCLENBQUMsQ0FBQztTQUM3QztRQUVELElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUNyQixDQUFDOzsrR0F4R1Usa0JBQWtCLGtCQVdULFlBQVksYUFBK0Msb0JBQW9CLDhDQUEyRSxpQkFBaUI7bUdBWHBMLGtCQUFrQix3Q0FYbEI7UUFDVDtZQUNFLE9BQU8sRUFBRSxvQkFBb0I7WUFDN0IsUUFBUSxFQUFFO2dCQUNSLE1BQU0sRUFBRSxFQUFFO2dCQUNWLE1BQU0sRUFBRSxFQUFFO2dCQUNWLFNBQVMsRUFBRSxLQUFLO2FBQ2pCO1NBQ0Y7S0FDRixpRENsQkgsbzVDQW1DZTsyRkRmRixrQkFBa0I7a0JBZjlCLFNBQVM7K0JBQ0UsZUFBZSxhQUdkO3dCQUNUOzRCQUNFLE9BQU8sRUFBRSxvQkFBb0I7NEJBQzdCLFFBQVEsRUFBRTtnQ0FDUixNQUFNLEVBQUUsRUFBRTtnQ0FDVixNQUFNLEVBQUUsRUFBRTtnQ0FDVixTQUFTLEVBQUUsS0FBSzs2QkFDakI7eUJBQ0Y7cUJBQ0Y7OzBCQWFZLE1BQU07MkJBQUMsWUFBWTs7MEJBQXdDLE1BQU07MkJBQUMsb0JBQW9COzswQkFBb0UsTUFBTTsyQkFBQyxpQkFBaUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDaGFuZ2VEZXRlY3RvclJlZiwgQ29tcG9uZW50LCBJbmplY3R9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSVJlcG9ydFR5cGUsIElucHV0UGFyYW1zLCBJQmlnTnVtYmVyQ29uZmlnLCBJQmlnTnVtYmVyLCBDaGFydFR5cGUsIFVwZGF0ZUlucHV0UGFyYW1zLCBTdHJpbmdPYmplY3QsIFJlcG9ydFN0YXRlLCBJRGF0YVNlcnZpY2UgfSBmcm9tICcuLi8uLi90eXBlcy9pbmRleCc7XG5pbXBvcnQgeyBCYXNlQ29tcG9uZW50IH0gZnJvbSAnLi4vYmFzZS9iYXNlLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBERUZBVUxUX0NPTkZJRyBhcyBERUZBVUxUX0NPTkZJR19UT0tFTiwgREFTSExFVF9DT05TVEFOVFMsIERBVEFfU0VSVklDRSB9IGZyb20gJy4uLy4uL3Rva2Vucy9pbmRleCc7XG5pbXBvcnQgeyBydW5BZ2dyZWdhdG9yIH0gZnJvbSAnLi9vcGVyYXRpb25zJztcbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ3NiLWJpZy1udW1iZXInLFxuICB0ZW1wbGF0ZVVybDogJy4vYmlnLW51bWJlci5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL2JpZy1udW1iZXIuY29tcG9uZW50LmNzcyddLFxuICBwcm92aWRlcnM6IFtcbiAgICB7XG4gICAgICBwcm92aWRlOiBERUZBVUxUX0NPTkZJR19UT0tFTixcbiAgICAgIHVzZVZhbHVlOiB7XG4gICAgICAgIGhlYWRlcjogJycsXG4gICAgICAgIGZvb3RlcjogJycsXG4gICAgICAgIG9wZXJhdGlvbjogJ1NVTSdcbiAgICAgIH1cbiAgICB9XG4gIF1cbn0pXG5leHBvcnQgY2xhc3MgQmlnTnVtYmVyQ29tcG9uZW50IGV4dGVuZHMgQmFzZUNvbXBvbmVudCBpbXBsZW1lbnRzIElCaWdOdW1iZXIge1xuXG4gIHB1YmxpYyBjb25maWc6IGFueTtcbiAgcHVibGljIHJlcG9ydFR5cGU6IElSZXBvcnRUeXBlID0gSVJlcG9ydFR5cGUuQ0hBUlQ7XG4gIHB1YmxpYyB0eXBlOiBDaGFydFR5cGUgPSBDaGFydFR5cGUuQklHX05VTUJFUjtcbiAgcHVibGljIF9kZWZhdWx0Q29uZmlnOiBJQmlnTnVtYmVyQ29uZmlnO1xuICBwdWJsaWMgaW5wdXRQYXJhbWV0ZXJzOiBJQmlnTnVtYmVyQ29uZmlnID0ge307XG4gIHB1YmxpYyBleHBvcnRPcHRpb25zID0gWydjc3YnXTtcblxuICBwcml2YXRlIF9iaWdOdW1iZXJDbG9zdXJlOiBhbnk7XG5cbiAgY29uc3RydWN0b3IoQEluamVjdChEQVRBX1NFUlZJQ0UpIHByb3RlY3RlZCBkYXRhU2VydmljZTogSURhdGFTZXJ2aWNlLCBASW5qZWN0KERFRkFVTFRfQ09ORklHX1RPS0VOKSBkZWZhdWx0Q29uZmlnOiBJQmlnTnVtYmVyQ29uZmlnLCBwcml2YXRlIGNkcjogQ2hhbmdlRGV0ZWN0b3JSZWYsIEBJbmplY3QoREFTSExFVF9DT05TVEFOVFMpIHByaXZhdGUgQ09OU1RBTlRTOiBTdHJpbmdPYmplY3QpIHtcbiAgICBzdXBlcihkYXRhU2VydmljZSk7XG4gICAgdGhpcy5fZGVmYXVsdENvbmZpZyA9IGRlZmF1bHRDb25maWc7XG4gIH1cblxuICBhc3luYyBpbml0aWFsaXplKHsgY29uZmlnLCBkYXRhLCB0eXBlID0gXCJiaWdOdW1iZXJcIiB9OiBJbnB1dFBhcmFtcyk6IFByb21pc2U8YW55PiB7XG4gICAgaWYgKCEoY29uZmlnICYmIGRhdGEpKSB0aHJvdyBuZXcgU3ludGF4RXJyb3IodGhpcy5DT05TVEFOVFMuSU5WQUxJRF9JTlBVVCk7XG4gICAgdGhpcy5jb25maWcgPSBjb25maWcgPSB7IC4uLmNvbmZpZywgdHlwZSB9O1xuICAgIGNvbnN0IGZldGNoZWRKU09OID0gdGhpcy5kYXRhID0gYXdhaXQgdGhpcy5mZXRjaERhdGEoZGF0YSkudG9Qcm9taXNlKCkuY2F0Y2goZXJyID0+IFtdKTtcbiAgICB0aGlzLmJ1aWxkZXIoY29uZmlnIGFzIElCaWdOdW1iZXJDb25maWcsIGZldGNoZWRKU09OKTtcbiAgICB0aGlzLl9pc0luaXRpYWxpemVkID0gdHJ1ZTtcbiAgICB0aGlzLnN0YXRlLmVtaXQoUmVwb3J0U3RhdGUuRE9ORSk7XG4gIH1cblxuICBidWlsZGVyKGNvbmZpZzogSUJpZ051bWJlckNvbmZpZywgSlNPTkRhdGEpIHtcbiAgICBjb25zdCB7IGhlYWRlciA9IHRoaXMuX2RlZmF1bHRDb25maWcuaGVhZGVyLCBmb290ZXIgPSB0aGlzLl9kZWZhdWx0Q29uZmlnLmZvb3RlciwgZGF0YUV4cHIsIG9wZXJhdGlvbiA9IHRoaXMuX2RlZmF1bHRDb25maWcub3BlcmF0aW9uIH0gPSBjb25maWc7XG4gICAgaWYgKCFkYXRhRXhwciB8fCAhSlNPTkRhdGEpIHtcbiAgICAgIHRocm93IEVycm9yKHRoaXMuQ09OU1RBTlRTLklOVkFMSURfSU5QVVQpO1xuICAgIH1cbiAgICB0aGlzLl9iaWdOdW1iZXJDbG9zdXJlID0gdGhpcy5iaWdOdW1iZXJEYXRhQ2xvc3VyZShkYXRhRXhwcikob3BlcmF0aW9uKShKU09ORGF0YSk7XG4gICAgY29uc3QgYmlnTnVtYmVyT2JqID0geyBoZWFkZXIsIGZvb3RlciwgZGF0YTogdGhpcy5fYmlnTnVtYmVyQ2xvc3VyZS5nZXREYXRhKCkgfVxuICAgIHRoaXMuc2V0QmlnTnVtYmVyRGF0YShiaWdOdW1iZXJPYmopO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRCaWdOdW1iZXJEYXRhKGNvbmZpZzogb2JqZWN0ID0ge30pIHtcbiAgICB0aGlzLmlucHV0UGFyYW1ldGVycyA9IHsgLi4udGhpcy5fZGVmYXVsdENvbmZpZywgLi4udGhpcy5pbnB1dFBhcmFtZXRlcnMsIC4uLmNvbmZpZyB9O1xuICAgIHRoaXMuJGNvbnRleHQgPSB7IGRhdGE6IHRoaXMuZGF0YSwgY29uZmlnOiB0aGlzLmNvbmZpZywgaW5wdXRQYXJhbWV0ZXJzOiB0aGlzLmlucHV0UGFyYW1ldGVycywgZXhwb3J0T3B0aW9uczogdGhpcy5leHBvcnRPcHRpb25zIH1cbiAgICB0aGlzLmNkci5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICBwcml2YXRlIGJpZ051bWJlckRhdGFDbG9zdXJlID0gKGRhdGFFeHByOiBzdHJpbmcpID0+ICRhZ2dyZWdhdGVGbiA9PiAoZGF0YTogb2JqZWN0W10pID0+IHtcbiAgICByZXR1cm4ge1xuICAgICAgZ2V0RGF0YShvdmVycmlkZGVuRGF0YT86IG9iamVjdFtdKSB7XG4gICAgICAgIGRhdGEgPSBvdmVycmlkZGVuRGF0YSB8fCBkYXRhO1xuICAgICAgICByZXR1cm4gcnVuQWdncmVnYXRvcigkYWdncmVnYXRlRm4sIGRhdGEsIGRhdGFFeHByKTtcbiAgICAgIH0sXG4gICAgICBhZGREYXRhKG5ld0RhdGE6IG9iamVjdFtdKSB7XG4gICAgICAgIGRhdGEgPSBkYXRhLmNvbmNhdChuZXdEYXRhKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RGF0YSgpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHJlc2V0KCk6IHZvaWQge1xuICAgIHRoaXMuZXZlbnRzU3ViamVjdC5uZXh0KCk7XG4gIH1cblxuICBkZXN0cm95KCk6IHZvaWQge1xuICAgIHRocm93IG5ldyBFcnJvcih0aGlzLkNPTlNUQU5UUy5NRVRIT0RfTk9UX0lNUExFTUVOVEVEKTtcbiAgfVxuXG4gIHVwZGF0ZShpbnB1dDogUGFydGlhbDxVcGRhdGVJbnB1dFBhcmFtcz4pIHtcbiAgICB0aGlzLmNoZWNrSWZJbml0aWFsaXplZCgpO1xuICAgIGlmICghaW5wdXQpIHRocm93IG5ldyBFcnJvcih0aGlzLkNPTlNUQU5UUy5JTlZBTElEX0lOUFVUKTtcbiAgICBjb25zdCB7IGNvbmZpZyA9IHt9LCBkYXRhID0gbnVsbCB9ID0gaW5wdXQ7XG4gICAgY29uc3QgeyBoZWFkZXIsIGZvb3RlciwgZGF0YUV4cHIsIG9wZXJhdGlvbiA9ICdTVU0nIH0gPSBjb25maWcgYXMgSUJpZ051bWJlckNvbmZpZztcbiAgICBsZXQgYmlnTnVtYmVyO1xuICAgIGlmIChkYXRhKSB7XG4gICAgICB0aGlzLl9iaWdOdW1iZXJDbG9zdXJlID0gKGRhdGFFeHByICYmIHRoaXMuYmlnTnVtYmVyRGF0YUNsb3N1cmUoZGF0YUV4cHIpKG9wZXJhdGlvbikoZGF0YSkpIHx8IHRoaXMuX2JpZ051bWJlckNsb3N1cmU7XG4gICAgICBiaWdOdW1iZXIgPSB0aGlzLl9iaWdOdW1iZXJDbG9zdXJlLmdldERhdGEoZGF0YSk7XG4gICAgfVxuICAgIHRoaXMuc2V0QmlnTnVtYmVyRGF0YSh7XG4gICAgICAuLi4oaGVhZGVyICYmIHsgaGVhZGVyIH0pLFxuICAgICAgLi4uKGZvb3RlciAmJiB7IGZvb3RlciB9KSxcbiAgICAgIC4uLihiaWdOdW1iZXIgJiYge1xuICAgICAgICBkYXRhOiBiaWdOdW1iZXJcbiAgICAgIH0pXG4gICAgfSlcbiAgfVxuXG4gIGFkZERhdGEoZGF0YTogb2JqZWN0IHwgb2JqZWN0W10pIHtcbiAgICBpZiAoIWRhdGEpIHRocm93IG5ldyBFcnJvcih0aGlzLkNPTlNUQU5UUy5JTlZBTElEX0lOUFVUKTtcbiAgICBkYXRhID0gQXJyYXkuaXNBcnJheShkYXRhKSA/IGRhdGEgOiBbZGF0YV07XG4gICAgY29uc3QgYmlnTnVtYmVyID0gdGhpcy5fYmlnTnVtYmVyQ2xvc3VyZS5hZGREYXRhKGRhdGEpO1xuICAgIHRoaXMuc2V0QmlnTnVtYmVyRGF0YSh7XG4gICAgICBkYXRhOiBiaWdOdW1iZXJcbiAgICB9KTtcbiAgfVxuXG4gIHJlZnJlc2hDaGFydCgpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IodGhpcy5DT05TVEFOVFMuTUVUSE9EX05PVF9JTVBMRU1FTlRFRCk7XG4gIH1cblxuICBnZXRUZWxlbWV0cnkoKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKHRoaXMuQ09OU1RBTlRTLk1FVEhPRF9OT1RfSU1QTEVNRU5URUQpO1xuICB9XG5cbiAgZXhwb3J0QXMoZm9ybWF0OiBzdHJpbmcpIHtcbiAgICBpZiAoIXRoaXMuZXhwb3J0T3B0aW9ucy5pbmNsdWRlcyhmb3JtYXQpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2dpdmVuIHR5cGUgbm90IHN1cHBvcnRlZCcpO1xuICAgIH1cblxuICAgIHRoaXMuZXhwb3J0QXNDc3YoKTtcbiAgfVxuICBcbn1cbiIsIjxuZy10ZW1wbGF0ZSAjZGVmYXVsdFRlbXBsYXRlIGxldC1jb25maWc+XG4gIDxkaXYgY2xhc3M9XCJ1aSBjYXJkc1wiPlxuICAgIDxkaXYgY2xhc3M9XCJjYXJkXCI+XG4gICAgICA8ZGl2IGNsYXNzPVwiY29udGVudFwiPlxuICAgICAgICA8ZGl2IGNsYXNzPVwiaGVhZGVyXCI+e3tjb25maWc/LmlucHV0UGFyYW1ldGVycz8uaGVhZGVyfX08L2Rpdj5cbiAgICAgICAgPGRpdiBjbGFzcz1cIm1ldGFcIj57e2NvbmZpZz8uaW5wdXRQYXJhbWV0ZXJzPy5mb290ZXJ9fTwvZGl2PlxuICAgICAgICA8ZGl2IGNsYXNzPVwiZGVzY3JpcHRpb25cIj5cbiAgICAgICAgICB7e2NvbmZpZz8uaW5wdXRQYXJhbWV0ZXJzPy5kYXRhfX1cbiAgICAgICAgPC9kaXY+XG4gICAgICA8L2Rpdj5cbiAgICA8L2Rpdj5cbiAgPC9kaXY+XG48L25nLXRlbXBsYXRlPlxuXG48bmctdGVtcGxhdGUgI2RlZmF1bHRGaWx0ZXJUZW1wbGF0ZSBsZXQtY29udGV4dD5cbiAgPHNiLWRhc2hsZXRzLWZpbHRlcnMgW2RhdGFdPVwiY29udGV4dD8uZGF0YVwiIFtjb25maWddPVwiY29udGV4dD8uY29uZmlnPy5maWx0ZXJzXCJcbiAgICAoZmlsdGVyZWREYXRhKT1cInVwZGF0ZSh7ZGF0YTogJGV2ZW50fSlcIiBbcmVzZXRGaWx0ZXJzXT1cImV2ZW50c1N1YmplY3QuYXNPYnNlcnZhYmxlKClcIj5cbiAgPC9zYi1kYXNobGV0cy1maWx0ZXJzPlxuPC9uZy10ZW1wbGF0ZT5cblxuPG5nLWNvbnRhaW5lciAqbmdJZj1cIiRjb250ZXh0Py5jb25maWc/LmZpbHRlcnNcIiBbbmdUZW1wbGF0ZU91dGxldF09XCJ0ZW1wbGF0ZVJlZnM/LmZpbHRlciB8fCBkZWZhdWx0RmlsdGVyVGVtcGxhdGVcIlxuICBbbmdUZW1wbGF0ZU91dGxldENvbnRleHRdPVwieyckaW1wbGljaXQnOiAkY29udGV4dH1cIj5cbjwvbmctY29udGFpbmVyPlxuXG5cbjxuZy1jb250YWluZXIgKm5nSWY9XCJ0ZW1wbGF0ZVJlZnM/LmhlYWRlciAmJiAkY29udGV4dFwiIFtuZ1RlbXBsYXRlT3V0bGV0XT1cInRlbXBsYXRlUmVmcz8uaGVhZGVyXCJcbiAgW25nVGVtcGxhdGVPdXRsZXRDb250ZXh0XT1cInsnJGltcGxpY2l0JzogJGNvbnRleHR9XCI+XG48L25nLWNvbnRhaW5lcj5cblxuPG5nLWNvbnRhaW5lciAqbmdJZj1cIiRjb250ZXh0XCIgW25nVGVtcGxhdGVPdXRsZXRdPVwidGVtcGxhdGVSZWZzPy5ib2R5IHx8IGRlZmF1bHRUZW1wbGF0ZVwiXG4gIFtuZ1RlbXBsYXRlT3V0bGV0Q29udGV4dF09XCJ7JyRpbXBsaWNpdCc6ICRjb250ZXh0fVwiPlxuPC9uZy1jb250YWluZXI+XG5cbjxuZy1jb250YWluZXIgKm5nSWY9XCJ0ZW1wbGF0ZVJlZnM/LmZvb3RlciAmJiAkY29udGV4dFwiIFtuZ1RlbXBsYXRlT3V0bGV0XT1cInRlbXBsYXRlUmVmcz8uZm9vdGVyXCJcbiAgW25nVGVtcGxhdGVPdXRsZXRDb250ZXh0XT1cInsnJGltcGxpY2l0JzogJGNvbnRleHR9XCI+XG48L25nLWNvbnRhaW5lcj4iXX0=