import { Component, Input, Output, EventEmitter, Inject, ViewChild } from '@angular/core';
import { DEFAULT_CONFIG } from '../../tokens/index';
import * as _ from 'lodash-es';
import { debounceTime, distinctUntilChanged, takeUntil, map, tap, pairwise, startWith } from 'rxjs/operators';
import { Subject, zip } from 'rxjs';
import { FILTER_DEFAULT_CONFIG } from './defaultConfiguration';
import dayjs from 'dayjs';
import customParseFormat from 'dayjs/plugin/customParseFormat';
import * as i0 from "@angular/core";
import * as i1 from "@angular/forms";
import * as i2 from "@angular/common";
import * as i3 from "ng-multiselect-dropdown";
import * as i4 from "ngx-daterangepicker-material";
dayjs.extend(customParseFormat);
const ranges = {
    'Today': [dayjs(), dayjs()],
    'Yesterday': [dayjs().subtract(1, 'day'), dayjs().subtract(1, 'day')],
    'Last 7 Days': [dayjs().subtract(6, 'day'), dayjs()],
    'Last 30 Days': [dayjs().subtract(29, 'day'), dayjs()],
    'This Month': [dayjs().startOf('month'), dayjs().endOf('month')],
    'Last Month': [dayjs().subtract(1, 'month').startOf('month'), dayjs().subtract(1, 'month').endOf('month')]
};
const sortDates = (dates, format = 'DD-MM-YYYY') => {
    return dates.sort((pre, next) => {
        const preDate = dayjs(pre, format), nextDate = dayjs(next, format);
        if (preDate.isSame(nextDate))
            return 0;
        if (preDate.isBefore(nextDate))
            return -1;
        return 1;
    });
};
export class FiltersComponent {
    constructor(fb, defaultConfig) {
        this.fb = fb;
        this.defaultConfig = defaultConfig;
        this.config = [];
        this.filteredData = new EventEmitter();
        this.unsubscribe$ = new Subject();
        this.ranges = ranges;
        this.locale = { applyLabel: 'Set Date', format: 'DD-MM-YYYY' };
        this._omitEmptyFilters = filters => _.omitBy(filters, _.isEmpty);
        this.transformFilterValues = filters => _.mapValues(filters, values => Array.isArray(values) ? values : [values]);
        this.getSelectedFiltersObservable = () => {
            return this.filtersFormGroup.valueChanges
                .pipe(takeUntil(this.unsubscribe$), debounceTime(1000), distinctUntilChanged(), map(this._omitEmptyFilters.bind(this)), map(this.transformFilterValues.bind(this)), startWith({}), pairwise());
        };
    }
    ngOnInit() {
        this._data = this.data;
        this.init(this.config, this._data);
        this.handleFilterValueChanges();
        this.resetFilters.subscribe(() => {
            this.filtersFormGroup.reset();
        });
    }
    _setDropdownSettings(config = {}) {
        return { ...this.defaultConfig.dropdownSettings, ...config };
    }
    _getFilterOptions(dataExpr, data) {
        const getFilterValue = dataExpr => row => (row && row[dataExpr]) || '';
        const inputDataArr = (data && Array.isArray(data) && data.map(getFilterValue(dataExpr))) || [];
        return _.compact(_.sortBy(_.uniq(inputDataArr)));
    }
    init(config, data) {
        this.filters = [];
        this.filtersFormGroup = this.fb.group({});
        config.forEach(filter => {
            const filterObj = { ...this.defaultConfig.config, ...filter };
            const { reference, default: defaultValue, searchable, controlType, dropdownSettings = {}, dateFormat } = filterObj;
            const options = this._getFilterOptions(reference, data);
            if (filter.controlType === 'date' || /date/i.test(reference)) {
                const sortedDateRange = sortDates([...options], dateFormat);
                filterObj['minDate'] = dayjs(sortedDateRange[0], dateFormat);
                filterObj['maxDate'] = dayjs(sortedDateRange[sortedDateRange.length - 1], dateFormat);
            }
            else {
                filterObj['dropdownSettings'] = this._setDropdownSettings({
                    singleSelection: controlType === 'single-select' ? true : false,
                    allowSearchFilter: searchable,
                    ...dropdownSettings
                });
            }
            filterObj.options = options;
            this.filtersFormGroup.addControl(reference, this.fb.control(defaultValue));
            this.filters.push(filterObj);
        });
    }
    handleFilterValueChanges() {
        const selectedFilters$ = this.getSelectedFiltersObservable();
        const filteredData$ = selectedFilters$.pipe(tap(console.log), map(([_, currentFilters]) => currentFilters), map(this.filterDataBySelectedFilters(this._data)));
        zip(selectedFilters$, filteredData$)
            .subscribe(([[previousFilters, currentFilters], filteredData]) => {
            _.forEach(this.filters, filter => {
                const { reference } = filter;
                const options = this._getFilterOptions(reference, filteredData);
                const referenceExistsInPreviousFilters = reference in previousFilters;
                const referenceExistsInCurrentFilters = reference in currentFilters;
                if (!referenceExistsInCurrentFilters || (referenceExistsInPreviousFilters && JSON.stringify(previousFilters[reference]) === JSON.stringify(currentFilters[reference]))) {
                    filter.options = options;
                    if (filter.controlType === 'date' || /date/i.test(reference)) {
                        const sortedDateRange = sortDates([...options], 'DD-MM-YYYY');
                        filter['minDate'] = dayjs(sortedDateRange[0], 'DD-MM-YYYY');
                        filter['maxDate'] = dayjs(sortedDateRange[sortedDateRange.length - 1], 'DD-MM-YYYY');
                    }
                }
            });
            this.filteredData.emit(filteredData);
        });
    }
    filterDataBySelectedFilters(JSON) {
        return selectedFilters => _.filter(JSON, data => {
            return _.every(selectedFilters, (values, key) => {
                if (data[key]) {
                    return _.some(values, value => _.trim(_.toLower(value)) === _.trim(_.toLower(data[key])));
                }
                return false;
            });
        });
    }
    ngOnDestroy() {
        this.unsubscribe$.next();
        this.unsubscribe$.complete();
    }
    updateDateRange({ startDate, endDate }, columnRef, dateFormat) {
        const selectedStartDate = dayjs(startDate).subtract(1, 'day');
        const selectedEndDate = dayjs(endDate).add(1, 'day');
        const dateRange = [];
        let currDate = dayjs(selectedStartDate).startOf('day');
        const lastDate = dayjs(selectedEndDate).startOf('day');
        while (currDate.diff(lastDate) < 0) {
            dateRange.push(currDate.clone().format(dateFormat));
            currDate = currDate.add(1, 'day');
        }
        this.filtersFormGroup.get(columnRef).setValue(dateRange);
    }
    reset() {
        this.filtersFormGroup.reset();
        if (this.datepicker) {
            this.datepicker.nativeElement.value = '';
        }
    }
}
FiltersComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.3.0", ngImport: i0, type: FiltersComponent, deps: [{ token: i1.UntypedFormBuilder }, { token: DEFAULT_CONFIG }], target: i0.ɵɵFactoryTarget.Component });
FiltersComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "14.3.0", type: FiltersComponent, selector: "sb-dashlets-filters", inputs: { config: "config", data: "data", resetFilters: "resetFilters" }, outputs: { filteredData: "filteredData" }, providers: [{
            provide: DEFAULT_CONFIG,
            useValue: FILTER_DEFAULT_CONFIG
        }], viewQueries: [{ propertyName: "datepicker", first: true, predicate: ["datePickerForFilters"], descendants: true }], ngImport: i0, template: "\n<ng-container *ngIf=\"filters?.length && filtersFormGroup\">\n    <form [formGroup]=\"filtersFormGroup\">\n        <div class=\"sb-filter-g\">\n                <ng-container *ngFor=\"let filter of filters\">\n                    <ng-container\n                        *ngIf=\"filter?.controlType === 'multi-select' || filter?.controlType === 'single-select'\">\n                        <ng-multiselect-dropdown class=\"sb-filter-g__item\"\n                            [placeholder]=\"filter?.placeholder || filter?.displayName || filter?.label\"\n                            [settings]=\"filter?.dropdownSettings\" [data]=\"filter?.options\"\n                            [formControlName]=\"filter.reference\">\n                        </ng-multiselect-dropdown>\n                    </ng-container>\n                    <ng-container *ngIf=\"filter?.controlType === 'date'\">\n                        <div class=\"sb-filter-g__item\">\n                            <input type=\"text\"\n                                [placeholder]=\"filter?.placeholder || filter?.displayName || filter?.label\"\n                                ngxDaterangepickerMd [minDate]=\"filter?.minDate\" [maxDate]=\"filter?.maxDate\"\n                                [ranges]=\"ranges\" [alwaysShowCalendars]=\"true\" [locale]=\"locale\"\n                                [linkedCalendars]=\"true\" [showCustomRangeLabel]=\"true\"\n                                (change)=\"updateDateRange($event,filter.reference, filter?.dateFormat)\"\n                                #datePickerForFilters />\n                        </div>\n                    </ng-container>\n                </ng-container>\n        </div>\n    </form>\n</ng-container>", styles: [".sb-filter-g{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:.5rem}.sb-filter-g__item{margin-bottom:.5rem;display:block;--white: #fff;background-color:var(--white)}.sb-filter-g__item input{width:100%;border:1px solid #adadad;height:35px;border-radius:.25rem;padding-left:.75rem;color:#333}\n"], dependencies: [{ kind: "directive", type: i2.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { kind: "directive", type: i2.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "directive", type: i1.ɵNgNoValidate, selector: "form:not([ngNoForm]):not([ngNativeValidate])" }, { kind: "directive", type: i1.NgControlStatus, selector: "[formControlName],[ngModel],[formControl]" }, { kind: "directive", type: i1.NgControlStatusGroup, selector: "[formGroupName],[formArrayName],[ngModelGroup],[formGroup],form:not([ngNoForm]),[ngForm]" }, { kind: "directive", type: i1.FormGroupDirective, selector: "[formGroup]", inputs: ["formGroup"], outputs: ["ngSubmit"], exportAs: ["ngForm"] }, { kind: "directive", type: i1.FormControlName, selector: "[formControlName]", inputs: ["formControlName", "disabled", "ngModel"], outputs: ["ngModelChange"] }, { kind: "component", type: i3.MultiSelectComponent, selector: "ng-multiselect-dropdown", inputs: ["disabled", "placeholder", "settings", "data"], outputs: ["onFilterChange", "onDropDownClose", "onSelect", "onDeSelect", "onSelectAll", "onDeSelectAll"] }, { kind: "directive", type: i4.DaterangepickerDirective, selector: "input[ngxDaterangepickerMd]", inputs: ["minDate", "maxDate", "autoApply", "alwaysShowCalendars", "showCustomRangeLabel", "linkedCalendars", "dateLimit", "singleDatePicker", "showWeekNumbers", "showISOWeekNumbers", "showDropdowns", "isInvalidDate", "isCustomDate", "isTooltipDate", "showClearButton", "customRangeDirection", "ranges", "opens", "drops", "firstMonthDayClass", "lastMonthDayClass", "emptyWeekRowClass", "emptyWeekColumnClass", "firstDayOfNextMonthClass", "lastDayOfPreviousMonthClass", "keepCalendarOpeningWithRange", "showRangeLabelOnInput", "showCancel", "lockStartDate", "timePicker", "timePicker24Hour", "timePickerIncrement", "timePickerSeconds", "closeOnAutoApply", "endKeyHolder", "startKey", "locale", "endKey"], outputs: ["change", "rangeClicked", "datesUpdated", "startDateChanged", "endDateChanged", "clearClicked"] }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.3.0", ngImport: i0, type: FiltersComponent, decorators: [{
            type: Component,
            args: [{ selector: 'sb-dashlets-filters', providers: [{
                            provide: DEFAULT_CONFIG,
                            useValue: FILTER_DEFAULT_CONFIG
                        }], template: "\n<ng-container *ngIf=\"filters?.length && filtersFormGroup\">\n    <form [formGroup]=\"filtersFormGroup\">\n        <div class=\"sb-filter-g\">\n                <ng-container *ngFor=\"let filter of filters\">\n                    <ng-container\n                        *ngIf=\"filter?.controlType === 'multi-select' || filter?.controlType === 'single-select'\">\n                        <ng-multiselect-dropdown class=\"sb-filter-g__item\"\n                            [placeholder]=\"filter?.placeholder || filter?.displayName || filter?.label\"\n                            [settings]=\"filter?.dropdownSettings\" [data]=\"filter?.options\"\n                            [formControlName]=\"filter.reference\">\n                        </ng-multiselect-dropdown>\n                    </ng-container>\n                    <ng-container *ngIf=\"filter?.controlType === 'date'\">\n                        <div class=\"sb-filter-g__item\">\n                            <input type=\"text\"\n                                [placeholder]=\"filter?.placeholder || filter?.displayName || filter?.label\"\n                                ngxDaterangepickerMd [minDate]=\"filter?.minDate\" [maxDate]=\"filter?.maxDate\"\n                                [ranges]=\"ranges\" [alwaysShowCalendars]=\"true\" [locale]=\"locale\"\n                                [linkedCalendars]=\"true\" [showCustomRangeLabel]=\"true\"\n                                (change)=\"updateDateRange($event,filter.reference, filter?.dateFormat)\"\n                                #datePickerForFilters />\n                        </div>\n                    </ng-container>\n                </ng-container>\n        </div>\n    </form>\n</ng-container>", styles: [".sb-filter-g{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:.5rem}.sb-filter-g__item{margin-bottom:.5rem;display:block;--white: #fff;background-color:var(--white)}.sb-filter-g__item input{width:100%;border:1px solid #adadad;height:35px;border-radius:.25rem;padding-left:.75rem;color:#333}\n"] }]
        }], ctorParameters: function () { return [{ type: i1.UntypedFormBuilder }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [DEFAULT_CONFIG]
                }] }]; }, propDecorators: { config: [{
                type: Input
            }], data: [{
                type: Input
            }], filteredData: [{
                type: Output
            }], resetFilters: [{
                type: Input
            }], datepicker: [{
                type: ViewChild,
                args: ['datePickerForFilters']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsdGVycy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9zYi1kYXNobGV0cy9zcmMvbGliL2NvbXBvbmVudHMvZmlsdGVycy9maWx0ZXJzLmNvbXBvbmVudC50cyIsIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3NiLWRhc2hsZXRzL3NyYy9saWIvY29tcG9uZW50cy9maWx0ZXJzL2ZpbHRlcnMuY29tcG9uZW50Lmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQVUsTUFBTSxFQUFFLFlBQVksRUFBYSxNQUFNLEVBQUUsU0FBUyxFQUFjLE1BQU0sZUFBZSxDQUFDO0FBRXpILE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNwRCxPQUFPLEtBQUssQ0FBQyxNQUFNLFdBQVcsQ0FBQTtBQUM5QixPQUFPLEVBQUUsWUFBWSxFQUFFLG9CQUFvQixFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM5RyxPQUFPLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBYSxNQUFNLE1BQU0sQ0FBQztBQUUvQyxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUMvRCxPQUFPLEtBQUssTUFBTSxPQUFPLENBQUM7QUFDMUIsT0FBTyxpQkFBaUIsTUFBTSxnQ0FBZ0MsQ0FBQzs7Ozs7O0FBQy9ELEtBQUssQ0FBQyxNQUFNLENBQUMsaUJBQWlCLENBQUMsQ0FBQTtBQUUvQixNQUFNLE1BQU0sR0FBUTtJQUNsQixPQUFPLEVBQUUsQ0FBQyxLQUFLLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQztJQUMzQixXQUFXLEVBQUUsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxFQUFF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U0FDbEM7UUFDRCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUMzRCxDQUFDO0lBRUQsS0FBSztRQUNILElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUM5QixJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDbkIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQztTQUMxQztJQUNILENBQUM7OzZHQWpKVSxnQkFBZ0Isb0RBa0J5QixjQUFjO2lHQWxCdkQsZ0JBQWdCLG1LQUxoQixDQUFDO1lBQ1YsT0FBTyxFQUFFLGNBQWM7WUFDdkIsUUFBUSxFQUFFLHFCQUFxQjtTQUNoQyxDQUFDLDhJQy9DSiwyckRBMkJlOzJGRHNCRixnQkFBZ0I7a0JBVDVCLFNBQVM7K0JBQ0UscUJBQXFCLGFBR3BCLENBQUM7NEJBQ1YsT0FBTyxFQUFFLGNBQWM7NEJBQ3ZCLFFBQVEsRUFBRSxxQkFBcUI7eUJBQ2hDLENBQUM7OzBCQW9CMkMsTUFBTTsyQkFBQyxjQUFjOzRDQWhCekQsTUFBTTtzQkFBZCxLQUFLO2dCQUNHLElBQUk7c0JBQVosS0FBSztnQkFDSSxZQUFZO3NCQUFyQixNQUFNO2dCQUNFLFlBQVk7c0JBQXBCLEtBQUs7Z0JBVzZCLFVBQVU7c0JBQTVDLFNBQVM7dUJBQUMsc0JBQXNCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBJbnB1dCwgT25Jbml0LCBPdXRwdXQsIEV2ZW50RW1pdHRlciwgT25EZXN0cm95LCBJbmplY3QsIFZpZXdDaGlsZCwgRWxlbWVudFJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgVW50eXBlZEZvcm1CdWlsZGVyLCBVbnR5cGVkRm9ybUdyb3VwIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgREVGQVVMVF9DT05GSUcgfSBmcm9tICcuLi8uLi90b2tlbnMvaW5kZXgnO1xuaW1wb3J0ICogYXMgXyBmcm9tICdsb2Rhc2gtZXMnXG5pbXBvcnQgeyBkZWJvdW5jZVRpbWUsIGRpc3RpbmN0VW50aWxDaGFuZ2VkLCB0YWtlVW50aWwsIG1hcCwgdGFwLCBwYWlyd2lzZSwgc3RhcnRXaXRoIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgU3ViamVjdCwgemlwLE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IElGaWx0ZXJDb25maWcgfSBmcm9tICcuLi8uLi90eXBlcy9pbmRleCdcbmltcG9ydCB7IEZJTFRFUl9ERUZBVUxUX0NPTkZJRyB9IGZyb20gJy4vZGVmYXVsdENvbmZpZ3VyYXRpb24nO1xuaW1wb3J0IGRheWpzIGZyb20gJ2RheWpzJztcbmltcG9ydCBjdXN0b21QYXJzZUZvcm1hdCBmcm9tICdkYXlqcy9wbHVnaW4vY3VzdG9tUGFyc2VGb3JtYXQnO1xuZGF5anMuZXh0ZW5kKGN1c3RvbVBhcnNlRm9ybWF0KVxuXG5jb25zdCByYW5nZXM6IGFueSA9IHtcbiAgJ1RvZGF5JzogW2RheWpzKCksIGRheWpzKCldLFxuICAnWWVzdGVyZGF5JzogW2RheWpzKCkuc3VidHJhY3QoMSwgJ2RheScpLCBkYXlqcygpLnN1YnRyYWN0KDEsICdkYXknKV0sXG4gICdMYXN0IDcgRGF5cyc6IFtkYXlqcygpLnN1YnRyYWN0KDYsICdkYXknKSwgZGF5anMoKV0sXG4gICdMYXN0IDMwIERheXMnOiBbZGF5anMoKS5zdWJ0cmFjdCgyOSwgJ2RheScpLCBkYXlqcygpXSxcbiAgJ1RoaXMgTW9udGgnOiBbZGF5anMoKS5zdGFydE9mKCdtb250aCcpLCBkYXlqcygpLmVuZE9mKCdtb250aCcpXSxcbiAgJ0xhc3QgTW9udGgnOiBbZGF5anMoKS5zdWJ0cmFjdCgxLCAnbW9udGgnKS5zdGFydE9mKCdtb250aCcpLCBkYXlqcygpLnN1YnRyYWN0KDEsICdtb250aCcpLmVuZE9mKCdtb250aCcpXVxufTtcblxuY29uc3Qgc29ydERhdGVzID0gKGRhdGVzOiBzdHJpbmdbXSwgZm9ybWF0ID0gJ0RELU1NLVlZWVknKSA9PiB7XG4gIHJldHVybiBkYXRlcy5zb3J0KChwcmUsIG5leHQpID0+IHtcbiAgICBjb25zdCBwcmVEYXRlID0gZGF5anMocHJlLCBmb3JtYXQpLCBuZXh0RGF0ZSA9IGRheWpzKG5leHQsIGZvcm1hdCk7XG4gICAgaWYgKHByZURhdGUuaXNTYW1lKG5leHREYXRlKSkgcmV0dXJuIDA7XG4gICAgaWYgKHByZURhdGUuaXNCZWZvcmUobmV4dERhdGUpKSByZXR1cm4gLTE7XG4gICAgcmV0dXJuIDE7XG4gIH0pO1xufVxuXG5pbnRlcmZhY2UgQWRkaXRpb25hbENvbmZpZyB7XG4gIG9wdGlvbnM/OiBzdHJpbmdbXTtcbiAgbWluRGF0ZT86IGFueTtcbiAgbWF4RGF0YT86IGFueTtcbiAgZHJvcGRvd25TZXR0aW5nczogb2JqZWN0O1xuICBkYXRlRm9ybWF0OiBzdHJpbmc7XG59XG5cbmV4cG9ydCB0eXBlIElGaWx0ZXJDb25maWd1cmF0aW9uID0gSUZpbHRlckNvbmZpZyAmIEFkZGl0aW9uYWxDb25maWdcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnc2ItZGFzaGxldHMtZmlsdGVycycsXG4gIHRlbXBsYXRlVXJsOiAnLi9maWx0ZXJzLmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vZmlsdGVycy5jb21wb25lbnQuc2NzcyddLFxuICBwcm92aWRlcnM6IFt7XG4gICAgcHJvdmlkZTogREVGQVVMVF9DT05GSUcsXG4gICAgdXNlVmFsdWU6IEZJTFRFUl9ERUZBVUxUX0NPTkZJR1xuICB9XVxufSlcbmV4cG9ydCBjbGFzcyBGaWx0ZXJzQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuXG4gIEBJbnB1dCgpIGNvbmZpZzogSUZpbHRlckNvbmZpZ1tdID0gW107XG4gIEBJbnB1dCgpIGRhdGE7XG4gIEBPdXRwdXQoKSBmaWx0ZXJlZERhdGEgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBJbnB1dCgpIHJlc2V0RmlsdGVyczogT2JzZXJ2YWJsZTx2b2lkPjtcblxuICBwcml2YXRlIF9kYXRhO1xuXG4gIHB1YmxpYyBmaWx0ZXJzRm9ybUdyb3VwOiBVbnR5cGVkRm9ybUdyb3VwO1xuICBwdWJsaWMgZmlsdGVyczogSUZpbHRlckNvbmZpZ3VyYXRpb25bXTtcbiAgcHVibGljIHVuc3Vic2NyaWJlJCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG4gIHB1YmxpYyByYW5nZXMgPSByYW5nZXM7XG4gIHB1YmxpYyBsb2NhbGUgPSB7IGFwcGx5TGFiZWw6ICdTZXQgRGF0ZScsIGZvcm1hdDogJ0RELU1NLVlZWVknIH07XG4gIHB1YmxpYyBkcm9wZG93blNldHRpbmdzOiBhbnk7XG5cbiAgQFZpZXdDaGlsZCgnZGF0ZVBpY2tlckZvckZpbHRlcnMnKSBkYXRlcGlja2VyOiBFbGVtZW50UmVmO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZmI6IFVudHlwZWRGb3JtQnVpbGRlciwgQEluamVjdChERUZBVUxUX0NPTkZJRykgcHJpdmF0ZSBkZWZhdWx0Q29uZmlnKSB7IH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLl9kYXRhID0gdGhpcy5kYXRhO1xuICAgIHRoaXMuaW5pdCh0aGlzLmNvbmZpZywgdGhpcy5fZGF0YSk7XG4gICAgdGhpcy5oYW5kbGVGaWx0ZXJWYWx1ZUNoYW5nZXMoKTtcblxuICAgICB0aGlzLnJlc2V0RmlsdGVycy5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICB0aGlzLmZpbHRlcnNGb3JtR3JvdXAucmVzZXQoKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgX3NldERyb3Bkb3duU2V0dGluZ3MoY29uZmlnOiBvYmplY3QgPSB7fSkge1xuICAgIHJldHVybiB7IC4uLnRoaXMuZGVmYXVsdENvbmZpZy5kcm9wZG93blNldHRpbmdzLCAuLi5jb25maWcgfTtcbiAgfVxuXG4gIHByaXZhdGUgX2dldEZpbHRlck9wdGlvbnMoZGF0YUV4cHI6IHN0cmluZywgZGF0YTogb2JqZWN0W10pIHtcbiAgICBjb25zdCBnZXRGaWx0ZXJWYWx1ZSA9IGRhdGFFeHByID0+IHJvdyA9PiAocm93ICYmIHJvd1tkYXRhRXhwcl0pIHx8ICcnO1xuICAgIGNvbnN0IGlucHV0RGF0YUFyciA9IChkYXRhICYmIEFycmF5LmlzQXJyYXkoZGF0YSkgJiYgZGF0YS5tYXAoZ2V0RmlsdGVyVmFsdWUoZGF0YUV4cHIpKSkgfHwgW107XG4gICAgcmV0dXJuIF8uY29tcGFjdChfLnNvcnRCeShfLnVuaXEoaW5wdXREYXRhQXJyKSkpO1xuICB9XG5cbiAgaW5pdChjb25maWc6IElGaWx0ZXJDb25maWdbXSwgZGF0YTogb2JqZWN0W10pIHtcbiAgICB0aGlzLmZpbHRlcnMgPSBbXTtcbiAgICB0aGlzLmZpbHRlcnNGb3JtR3JvdXAgPSB0aGlzLmZiLmdyb3VwKHt9KTtcbiAgICBjb25maWcuZm9yRWFjaChmaWx0ZXIgPT4ge1xuICAgICAgY29uc3QgZmlsdGVyT2JqOiBJRmlsdGVyQ29uZmlndXJhdGlvbiA9IHsgLi4udGhpcy5kZWZhdWx0Q29uZmlnLmNvbmZpZywgLi4uZmlsdGVyIH07XG4gICAgICBjb25zdCB7IHJlZmVyZW5jZSwgZGVmYXVsdDogZGVmYXVsdFZhbHVlLCBzZWFyY2hhYmxlLCBjb250cm9sVHlwZSwgZHJvcGRvd25TZXR0aW5ncyA9IHt9LCBkYXRlRm9ybWF0IH0gPSBmaWx0ZXJPYmo7XG4gICAgICBjb25zdCBvcHRpb25zID0gdGhpcy5fZ2V0RmlsdGVyT3B0aW9ucyhyZWZlcmVuY2UsIGRhdGEpO1xuICAgICAgaWYgKGZpbHRlci5jb250cm9sVHlwZSA9PT0gJ2RhdGUnIHx8IC9kYXRlL2kudGVzdChyZWZlcmVuY2UpKSB7XG4gICAgICAgIGNvbnN0IHNvcnRlZERhdGVSYW5nZSA9IHNvcnREYXRlcyhbLi4ub3B0aW9uc10sIGRhdGVGb3JtYXQpO1xuICAgICAgICBmaWx0ZXJPYmpbJ21pbkRhdGUnXSA9IGRheWpzKHNvcnRlZERhdGVSYW5nZVswXSwgZGF0ZUZvcm1hdCk7XG4gICAgICAgIGZpbHRlck9ialsnbWF4RGF0ZSddID0gZGF5anMoc29ydGVkRGF0ZVJhbmdlW3NvcnRlZERhdGVSYW5nZS5sZW5ndGggLSAxXSwgZGF0ZUZvcm1hdCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBmaWx0ZXJPYmpbJ2Ryb3Bkb3duU2V0dGluZ3MnXSA9IHRoaXMuX3NldERyb3Bkb3duU2V0dGluZ3Moe1xuICAgICAgICAgIHNpbmdsZVNlbGVjdGlvbjogY29udHJvbFR5cGUgPT09ICdzaW5nbGUtc2VsZWN0JyA/IHRydWUgOiBmYWxzZSxcbiAgICAgICAgICBhbGxvd1NlYXJjaEZpbHRlcjogc2VhcmNoYWJsZSxcbiAgICAgICAgICAuLi5kcm9wZG93blNldHRpbmdzXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgZmlsdGVyT2JqLm9wdGlvbnMgPSBvcHRpb25zO1xuICAgICAgdGhpcy5maWx0ZXJzRm9ybUdyb3VwLmFkZENvbnRyb2wocmVmZXJlbmNlLCB0aGlzLmZiLmNvbnRyb2woZGVmYXVsdFZhbHVlKSk7XG4gICAgICB0aGlzLmZpbHRlcnMucHVzaChmaWx0ZXJPYmopO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBfb21pdEVtcHR5RmlsdGVycyA9IGZpbHRlcnMgPT4gXy5vbWl0QnkoZmlsdGVycywgXy5pc0VtcHR5KTtcblxuICBwcml2YXRlIHRyYW5zZm9ybUZpbHRlclZhbHVlcyA9IGZpbHRlcnMgPT4gXy5tYXBWYWx1ZXMoZmlsdGVycywgdmFsdWVzID0+IEFycmF5LmlzQXJyYXkodmFsdWVzKSA/IHZhbHVlcyA6IFt2YWx1ZXNdKTtcblxuICBwcml2YXRlIGdldFNlbGVjdGVkRmlsdGVyc09ic2VydmFibGUgPSAoKSA9PiB7XG4gICAgcmV0dXJuIHRoaXMuZmlsdGVyc0Zvcm1Hcm91cC52YWx1ZUNoYW5nZXNcbiAgICAgIC5waXBlKFxuICAgICAgICB0YWtlVW50aWwodGhpcy51bnN1YnNjcmliZSQpLFxuICAgICAgICBkZWJvdW5jZVRpbWUoMTAwMCksXG4gICAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKCksXG4gICAgICAgIG1hcCh0aGlzLl9vbWl0RW1wdHlGaWx0ZXJzLmJpbmQodGhpcykpLFxuICAgICAgICBtYXAodGhpcy50cmFuc2Zvcm1GaWx0ZXJWYWx1ZXMuYmluZCh0aGlzKSksXG4gICAgICAgIHN0YXJ0V2l0aCh7fSksXG4gICAgICAgIHBhaXJ3aXNlKClcbiAgICAgICk7XG4gIH1cblxuXG4gIGhhbmRsZUZpbHRlclZhbHVlQ2hhbmdlcygpIHtcbiAgICBjb25zdCBzZWxlY3RlZEZpbHRlcnMkID0gdGhpcy5nZXRTZWxlY3RlZEZpbHRlcnNPYnNlcnZhYmxlKCk7XG5cbiAgICBjb25zdCBmaWx0ZXJlZERhdGEkID0gc2VsZWN0ZWRGaWx0ZXJzJC5waXBlKFxuICAgICAgdGFwKGNvbnNvbGUubG9nKSxcbiAgICAgIG1hcCgoW18sIGN1cnJlbnRGaWx0ZXJzXSkgPT4gY3VycmVudEZpbHRlcnMpLFxuICAgICAgbWFwKHRoaXMuZmlsdGVyRGF0YUJ5U2VsZWN0ZWRGaWx0ZXJzKHRoaXMuX2RhdGEpKVxuICAgIClcblxuICAgIHppcChzZWxlY3RlZEZpbHRlcnMkLCBmaWx0ZXJlZERhdGEkKVxuICAgICAgLnN1YnNjcmliZSgoW1twcmV2aW91c0ZpbHRlcnMsIGN1cnJlbnRGaWx0ZXJzXSwgZmlsdGVyZWREYXRhXSkgPT4ge1xuICAgICAgICBfLmZvckVhY2godGhpcy5maWx0ZXJzLCBmaWx0ZXIgPT4ge1xuICAgICAgICAgIGNvbnN0IHsgcmVmZXJlbmNlIH0gPSBmaWx0ZXI7XG4gICAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHRoaXMuX2dldEZpbHRlck9wdGlvbnMocmVmZXJlbmNlLCBmaWx0ZXJlZERhdGEpO1xuICAgICAgICAgIGNvbnN0IHJlZmVyZW5jZUV4aXN0c0luUHJldmlvdXNGaWx0ZXJzID0gcmVmZXJlbmNlIGluIChwcmV2aW91c0ZpbHRlcnMgYXMgb2JqZWN0KTtcbiAgICAgICAgICBjb25zdCByZWZlcmVuY2VFeGlzdHNJbkN1cnJlbnRGaWx0ZXJzID0gcmVmZXJlbmNlIGluIChjdXJyZW50RmlsdGVycyBhcyBvYmplY3QpO1xuICAgICAgICAgIGlmICghcmVmZXJlbmNlRXhpc3RzSW5DdXJyZW50RmlsdGVycyB8fCAocmVmZXJlbmNlRXhpc3RzSW5QcmV2aW91c0ZpbHRlcnMgJiYgSlNPTi5zdHJpbmdpZnkocHJldmlvdXNGaWx0ZXJzW3JlZmVyZW5jZV0pID09PSBKU09OLnN0cmluZ2lmeShjdXJyZW50RmlsdGVyc1tyZWZlcmVuY2VdKSkpIHtcbiAgICAgICAgICAgIGZpbHRlci5vcHRpb25zID0gb3B0aW9ucztcbiAgICAgICAgICAgIGlmIChmaWx0ZXIuY29udHJvbFR5cGUgPT09ICdkYXRlJyB8fCAvZGF0ZS9pLnRlc3QocmVmZXJlbmNlKSkge1xuICAgICAgICAgICAgICBjb25zdCBzb3J0ZWREYXRlUmFuZ2UgPSBzb3J0RGF0ZXMoWy4uLm9wdGlvbnNdLCAnREQtTU0tWVlZWScpO1xuICAgICAgICAgICAgICBmaWx0ZXJbJ21pbkRhdGUnXSA9IGRheWpzKHNvcnRlZERhdGVSYW5nZVswXSwgJ0RELU1NLVlZWVknKTtcbiAgICAgICAgICAgICAgZmlsdGVyWydtYXhEYXRlJ10gPSBkYXlqcyhzb3J0ZWREYXRlUmFuZ2Vbc29ydGVkRGF0ZVJhbmdlLmxlbmd0aCAtIDFdLCAnREQtTU0tWVlZWScpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgICAgdGhpcy5maWx0ZXJlZERhdGEuZW1pdChmaWx0ZXJlZERhdGEpO1xuICAgICAgfSlcbiAgfVxuXG4gIGZpbHRlckRhdGFCeVNlbGVjdGVkRmlsdGVycyhKU09OKSB7XG4gICAgcmV0dXJuIHNlbGVjdGVkRmlsdGVycyA9PiBfLmZpbHRlcihKU09OLCBkYXRhID0+IHtcbiAgICAgIHJldHVybiBfLmV2ZXJ5KHNlbGVjdGVkRmlsdGVycywgKHZhbHVlcywga2V5KSA9PiB7XG4gICAgICAgIGlmIChkYXRhW2tleV0pIHtcbiAgICAgICAgICByZXR1cm4gXy5zb21lKHZhbHVlcywgdmFsdWUgPT4gXy50cmltKF8udG9Mb3dlcih2YWx1ZSkpID09PSBfLnRyaW0oXy50b0xvd2VyKGRhdGFba2V5XSkpKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMudW5zdWJzY3JpYmUkLm5leHQoKTtcbiAgICB0aGlzLnVuc3Vic2NyaWJlJC5jb21wbGV0ZSgpO1xuICB9XG5cbiAgdXBkYXRlRGF0ZVJhbmdlKHsgc3RhcnREYXRlLCBlbmREYXRlIH0sIGNvbHVtblJlZiwgZGF0ZUZvcm1hdCkge1xuICAgIGNvbnN0IHNlbGVjdGVkU3RhcnREYXRlID0gZGF5anMoc3RhcnREYXRlKS5zdWJ0cmFjdCgxLCAnZGF5Jyk7XG4gICAgY29uc3Qgc2VsZWN0ZWRFbmREYXRlID0gZGF5anMoZW5kRGF0ZSkuYWRkKDEsICdkYXknKTtcbiAgICBjb25zdCBkYXRlUmFuZ2UgPSBbXTtcbiAgICBsZXQgY3VyckRhdGUgPSBkYXlqcyhzZWxlY3RlZFN0YXJ0RGF0ZSkuc3RhcnRPZignZGF5Jyk7XG4gICAgY29uc3QgbGFzdERhdGUgPSBkYXlqcyhzZWxlY3RlZEVuZERhdGUpLnN0YXJ0T2YoJ2RheScpO1xuICAgIHdoaWxlIChjdXJyRGF0ZS5kaWZmKGxhc3REYXRlKSA8IDApIHtcbiAgICAgIGRhdGVSYW5nZS5wdXNoKGN1cnJEYXRlLmNsb25lKCkuZm9ybWF0KGRhdGVGb3JtYXQpKTtcbiAgICAgIGN1cnJEYXRlID0gY3VyckRhdGUuYWRkKDEsICdkYXknKVxuICAgIH1cbiAgICB0aGlzLmZpbHRlcnNGb3JtR3JvdXAuZ2V0KGNvbHVtblJlZikuc2V0VmFsdWUoZGF0ZVJhbmdlKTtcbiAgfVxuXG4gIHJlc2V0KCkge1xuICAgIHRoaXMuZmlsdGVyc0Zvcm1Hcm91cC5yZXNldCgpO1xuICAgIGlmICh0aGlzLmRhdGVwaWNrZXIpIHtcbiAgICAgIHRoaXMuZGF0ZXBpY2tlci5uYXRpdmVFbGVtZW50LnZhbHVlID0gJyc7XG4gICAgfVxuICB9XG59XG4iLCJcbjxuZy1jb250YWluZXIgKm5nSWY9XCJmaWx0ZXJzPy5sZW5ndGggJiYgZmlsdGVyc0Zvcm1Hcm91cFwiPlxuICAgIDxmb3JtIFtmb3JtR3JvdXBdPVwiZmlsdGVyc0Zvcm1Hcm91cFwiPlxuICAgICAgICA8ZGl2IGNsYXNzPVwic2ItZmlsdGVyLWdcIj5cbiAgICAgICAgICAgICAgICA8bmctY29udGFpbmVyICpuZ0Zvcj1cImxldCBmaWx0ZXIgb2YgZmlsdGVyc1wiPlxuICAgICAgICAgICAgICAgICAgICA8bmctY29udGFpbmVyXG4gICAgICAgICAgICAgICAgICAgICAgICAqbmdJZj1cImZpbHRlcj8uY29udHJvbFR5cGUgPT09ICdtdWx0aS1zZWxlY3QnIHx8IGZpbHRlcj8uY29udHJvbFR5cGUgPT09ICdzaW5nbGUtc2VsZWN0J1wiPlxuICAgICAgICAgICAgICAgICAgICAgICAgPG5nLW11bHRpc2VsZWN0LWRyb3Bkb3duIGNsYXNzPVwic2ItZmlsdGVyLWdfX2l0ZW1cIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtwbGFjZWhvbGRlcl09XCJmaWx0ZXI/LnBsYWNlaG9sZGVyIHx8IGZpbHRlcj8uZGlzcGxheU5hbWUgfHwgZmlsdGVyPy5sYWJlbFwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgW3NldHRpbmdzXT1cImZpbHRlcj8uZHJvcGRvd25TZXR0aW5nc1wiIFtkYXRhXT1cImZpbHRlcj8ub3B0aW9uc1wiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgW2Zvcm1Db250cm9sTmFtZV09XCJmaWx0ZXIucmVmZXJlbmNlXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICA8L25nLW11bHRpc2VsZWN0LWRyb3Bkb3duPlxuICAgICAgICAgICAgICAgICAgICA8L25nLWNvbnRhaW5lcj5cbiAgICAgICAgICAgICAgICAgICAgPG5nLWNvbnRhaW5lciAqbmdJZj1cImZpbHRlcj8uY29udHJvbFR5cGUgPT09ICdkYXRlJ1wiPlxuICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz1cInNiLWZpbHRlci1nX19pdGVtXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9XCJ0ZXh0XCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgW3BsYWNlaG9sZGVyXT1cImZpbHRlcj8ucGxhY2Vob2xkZXIgfHwgZmlsdGVyPy5kaXNwbGF5TmFtZSB8fCBmaWx0ZXI/LmxhYmVsXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmd4RGF0ZXJhbmdlcGlja2VyTWQgW21pbkRhdGVdPVwiZmlsdGVyPy5taW5EYXRlXCIgW21heERhdGVdPVwiZmlsdGVyPy5tYXhEYXRlXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgW3Jhbmdlc109XCJyYW5nZXNcIiBbYWx3YXlzU2hvd0NhbGVuZGFyc109XCJ0cnVlXCIgW2xvY2FsZV09XCJsb2NhbGVcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbbGlua2VkQ2FsZW5kYXJzXT1cInRydWVcIiBbc2hvd0N1c3RvbVJhbmdlTGFiZWxdPVwidHJ1ZVwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChjaGFuZ2UpPVwidXBkYXRlRGF0ZVJhbmdlKCRldmVudCxmaWx0ZXIucmVmZXJlbmNlLCBmaWx0ZXI/LmRhdGVGb3JtYXQpXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgI2RhdGVQaWNrZXJGb3JGaWx0ZXJzIC8+XG4gICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgPC9uZy1jb250YWluZXI+XG4gICAgICAgICAgICAgICAgPC9uZy1jb250YWluZXI+XG4gICAgICAgIDwvZGl2PlxuICAgIDwvZm9ybT5cbjwvbmctY29udGFpbmVyPiJdfQ==