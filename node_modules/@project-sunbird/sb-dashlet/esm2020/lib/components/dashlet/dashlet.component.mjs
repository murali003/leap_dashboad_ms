import { Component, ContentChildren, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { ReportWrapperDirective, TemplateRefsDirective } from '../../directives/index';
import { TYPE_TO_COMPONENT_MAPPING } from './type_to_component_mapping';
import { v4 as uuidv4 } from 'uuid';
import { defaultObjectSchemaAllowingAllKeys, validateInputAgainstSchema } from './schema';
import * as i0 from "@angular/core";
import * as i1 from "../../directives/reportWrapper/report-wrapper.directive";
const transformTemplates = (result, current) => {
    result[current.slot] = current.templateRef;
    return result;
};
export class DashletComponent {
    constructor(componentFactoryResolver) {
        this.componentFactoryResolver = componentFactoryResolver;
        this.events = new EventEmitter();
        this._typeToComponentMapping = Object.freeze(TYPE_TO_COMPONENT_MAPPING);
    }
    get instance() {
        return this._componentInstance;
    }
    set instance(componentInstance) {
        this._componentInstance = componentInstance;
    }
    ngOnInit() {
        this.id = uuidv4();
    }
    ngOnChanges(changes) {
        if (this.type && this.config && this.data) {
            this.loadComponent(this.type).catch(err => {
                console.error(err);
                throw err;
            });
        }
    }
    async loadComponent(type) {
        const componentResolver = this._typeToComponentMapping && this._typeToComponentMapping[type];
        if (!componentResolver) {
            throw new Error('Given Type not supported');
        }
        const { componentPath, schemaPath = Promise.resolve(defaultObjectSchemaAllowingAllKeys) } = componentResolver;
        const schema = await schemaPath;
        const input = { data: this.data, config: this.config, type: this.type };
        const { error } = validateInputAgainstSchema(schema)(input);
        if (error) {
            throw new SyntaxError(error.message);
        }
        const component = await componentPath;
        this.reportWrapper.viewContainerRef.clear();
        const componentFactory = this.componentFactoryResolver.resolveComponentFactory(component);
        const componentRef = this.reportWrapper.viewContainerRef.createComponent(componentFactory);
        const instance = this.instance = componentRef.instance;
        if (this.templateRefs.length) {
            instance['templateRefs'] = this.templateRefs.toArray().reduce(transformTemplates, {});
        }
        instance.id = this.id;
        instance.initialize({ config: this.config, type: this.type, data: this.data });
        instance.state.subscribe(this._stateEventsHandler.bind(this));
        instance.events.subscribe(this._eventsHandler.bind(this));
    }
    _stateEventsHandler(event) {
        this.events.emit({ type: 'STATE', event });
    }
    _eventsHandler(event) {
        this.events.emit(event);
    }
    filter(filteredData) {
        this.instance.update({ data: filteredData });
    }
    reset() {
        this.instance.reset();
    }
}
DashletComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.3.0", ngImport: i0, type: DashletComponent, deps: [{ token: i0.ComponentFactoryResolver }], target: i0.ɵɵFactoryTarget.Component });
DashletComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "14.3.0", type: DashletComponent, selector: "sb-dashlet", inputs: { type: "type", config: "config", data: "data" }, outputs: { events: "events" }, queries: [{ propertyName: "templateRefs", predicate: TemplateRefsDirective }], viewQueries: [{ propertyName: "reportWrapper", first: true, predicate: ReportWrapperDirective, descendants: true, static: true }], usesOnChanges: true, ngImport: i0, template: "<div>\n    <ng-template sbReportWrapper></ng-template>\n</div>", styles: [""], dependencies: [{ kind: "directive", type: i1.ReportWrapperDirective, selector: "[sbReportWrapper]" }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.3.0", ngImport: i0, type: DashletComponent, decorators: [{
            type: Component,
            args: [{ selector: 'sb-dashlet', template: "<div>\n    <ng-template sbReportWrapper></ng-template>\n</div>" }]
        }], ctorParameters: function () { return [{ type: i0.ComponentFactoryResolver }]; }, propDecorators: { type: [{
                type: Input
            }], config: [{
                type: Input
            }], data: [{
                type: Input
            }], events: [{
                type: Output
            }], reportWrapper: [{
                type: ViewChild,
                args: [ReportWrapperDirective, { static: true }]
            }], templateRefs: [{
                type: ContentChildren,
                args: [TemplateRefsDirective]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGFzaGxldC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9zYi1kYXNobGV0cy9zcmMvbGliL2NvbXBvbmVudHMvZGFzaGxldC9kYXNobGV0LmNvbXBvbmVudC50cyIsIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3NiLWRhc2hsZXRzL3NyYy9saWIvY29tcG9uZW50cy9kYXNobGV0L2Rhc2hsZXQuY29tcG9uZW50Lmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBNEIsZUFBZSxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQXFCLE1BQU0sRUFBeUMsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3ZMLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxxQkFBcUIsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRXZGLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQ3hFLE9BQU8sRUFBRSxFQUFFLElBQUksTUFBTSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3BDLE9BQU8sRUFBRSxrQ0FBa0MsRUFBRSwwQkFBMEIsRUFBRSxNQUFNLFVBQVUsQ0FBQTs7O0FBSXpGLE1BQU0sa0JBQWtCLEdBQUcsQ0FBQyxNQUFjLEVBQUUsT0FBd0QsRUFBRSxFQUFFO0lBQ3RHLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQztJQUMzQyxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDLENBQUE7QUFNRCxNQUFNLE9BQU8sZ0JBQWdCO0lBdUIzQixZQUFvQix3QkFBa0Q7UUFBbEQsNkJBQXdCLEdBQXhCLHdCQUF3QixDQUEwQjtRQWpCNUQsV0FBTSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFNckIsNEJBQXVCLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO0lBV1Ys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LENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUM1RCxDQUFDO0lBRU8sbUJBQW1CLENBQUMsS0FBa0I7UUFDNUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUVPLGNBQWMsQ0FBQyxLQUFrQjtRQUN2QyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUMxQixDQUFDO0lBRU0sTUFBTSxDQUFDLFlBQVk7UUFDeEIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsRUFBRSxJQUFJLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FBQztJQUMvQyxDQUFDO0lBQ00sS0FBSztRQUNWLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDeEIsQ0FBQzs7NkdBM0VVLGdCQUFnQjtpR0FBaEIsZ0JBQWdCLHdLQVNWLHFCQUFxQiw0RUFEM0Isc0JBQXNCLG1GQzFCbkMsZ0VBRU07MkZEZ0JPLGdCQUFnQjtrQkFMNUIsU0FBUzsrQkFDRSxZQUFZOytHQU1iLElBQUk7c0JBQVosS0FBSztnQkFDRyxNQUFNO3NCQUFkLEtBQUs7Z0JBQ0csSUFBSTtzQkFBWixLQUFLO2dCQUVJLE1BQU07c0JBQWYsTUFBTTtnQkFFOEMsYUFBYTtzQkFBakUsU0FBUzt1QkFBQyxzQkFBc0IsRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUU7Z0JBQ1gsWUFBWTtzQkFBbkQsZUFBZTt1QkFBQyxxQkFBcUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgQ29udGVudENoaWxkcmVuLCBFdmVudEVtaXR0ZXIsIElucHV0LCBPbkNoYW5nZXMsIE9uSW5pdCwgT3V0cHV0LCBRdWVyeUxpc3QsIFNpbXBsZUNoYW5nZXMsIFRlbXBsYXRlUmVmLCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFJlcG9ydFdyYXBwZXJEaXJlY3RpdmUsIFRlbXBsYXRlUmVmc0RpcmVjdGl2ZSB9IGZyb20gJy4uLy4uL2RpcmVjdGl2ZXMvaW5kZXgnO1xuaW1wb3J0IHsgQ3VzdG9tRXZlbnQsIElCYXNlLCBSZXBvcnRTdGF0ZSB9IGZyb20gJy4uLy4uL3R5cGVzL2luZGV4JztcbmltcG9ydCB7IFRZUEVfVE9fQ09NUE9ORU5UX01BUFBJTkcgfSBmcm9tICcuL3R5cGVfdG9fY29tcG9uZW50X21hcHBpbmcnO1xuaW1wb3J0IHsgdjQgYXMgdXVpZHY0IH0gZnJvbSAndXVpZCc7XG5pbXBvcnQgeyBkZWZhdWx0T2JqZWN0U2NoZW1hQWxsb3dpbmdBbGxLZXlzLCB2YWxpZGF0ZUlucHV0QWdhaW5zdFNjaGVtYSB9IGZyb20gJy4vc2NoZW1hJ1xuXG50eXBlIGNvbXBvbmVudEluc3RhbmNlVHlwZSA9IFBpY2s8SUJhc2UsIFwiaW5pdGlhbGl6ZVwiIHwgXCJldmVudHNcIiB8IFwic3RhdGVcIiB8IFwiaWRcIj47XG5cbmNvbnN0IHRyYW5zZm9ybVRlbXBsYXRlcyA9IChyZXN1bHQ6IG9iamVjdCwgY3VycmVudDogeyBzbG90OiBzdHJpbmcsIHRlbXBsYXRlUmVmOiBUZW1wbGF0ZVJlZjxhbnk+IH0pID0+IHtcbiAgcmVzdWx0W2N1cnJlbnQuc2xvdF0gPSBjdXJyZW50LnRlbXBsYXRlUmVmO1xuICByZXR1cm4gcmVzdWx0O1xufVxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnc2ItZGFzaGxldCcsXG4gIHRlbXBsYXRlVXJsOiAnLi9kYXNobGV0LmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vZGFzaGxldC5jb21wb25lbnQuY3NzJ11cbn0pXG5leHBvcnQgY2xhc3MgRGFzaGxldENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzIHtcblxuICBASW5wdXQoKSB0eXBlOiBzdHJpbmc7XG4gIEBJbnB1dCgpIGNvbmZpZzogb2JqZWN0O1xuICBASW5wdXQoKSBkYXRhOiBvYmplY3Q7XG5cbiAgQE91dHB1dCgpIGV2ZW50cyA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgXG4gIEBWaWV3Q2hpbGQoUmVwb3J0V3JhcHBlckRpcmVjdGl2ZSwgeyBzdGF0aWM6IHRydWUgfSkgcmVwb3J0V3JhcHBlcjogUmVwb3J0V3JhcHBlckRpcmVjdGl2ZTtcbiAgQENvbnRlbnRDaGlsZHJlbihUZW1wbGF0ZVJlZnNEaXJlY3RpdmUpIHRlbXBsYXRlUmVmczogUXVlcnlMaXN0PFRlbXBsYXRlUmVmc0RpcmVjdGl2ZT47XG5cbiAgcHJpdmF0ZSBfY29tcG9uZW50SW5zdGFuY2U7XG4gIHByaXZhdGUgcmVhZG9ubHkgX3R5cGVUb0NvbXBvbmVudE1hcHBpbmcgPSBPYmplY3QuZnJlZXplKFRZUEVfVE9fQ09NUE9ORU5UX01BUFBJTkcpO1xuICBwdWJsaWMgaWQ6IHN0cmluZztcblxuXG4gIGdldCBpbnN0YW5jZSgpIHtcbiAgICByZXR1cm4gdGhpcy5fY29tcG9uZW50SW5zdGFuY2U7XG4gIH1cbiAgc2V0IGluc3RhbmNlKGNvbXBvbmVudEluc3RhbmNlKSB7XG4gICAgdGhpcy5fY29tcG9uZW50SW5zdGFuY2UgPSBjb21wb25lbnRJbnN0YW5jZTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgY29tcG9uZW50RmFjdG9yeVJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIpIHsgfVxuXG4gIG5nT25Jbml0KCk6IHZvaWQge1xuICAgIHRoaXMuaWQgPSB1dWlkdjQoKTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcbiAgICBpZiAodGhpcy50eXBlICYmIHRoaXMuY29uZmlnICYmIHRoaXMuZGF0YSkge1xuICAgICAgdGhpcy5sb2FkQ29tcG9uZW50KHRoaXMudHlwZSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICB0aHJvdyBlcnI7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBsb2FkQ29tcG9uZW50KHR5cGU6IHN0cmluZykge1xuICAgIGNvbnN0IGNvbXBvbmVudFJlc29sdmVyID0gdGhpcy5fdHlwZVRvQ29tcG9uZW50TWFwcGluZyAmJiB0aGlzLl90eXBlVG9Db21wb25lbnRNYXBwaW5nW3R5cGVdO1xuICAgIGlmICghY29tcG9uZW50UmVzb2x2ZXIpIHsgdGhyb3cgbmV3IEVycm9yKCdHaXZlbiBUeXBlIG5vdCBzdXBwb3J0ZWQnKTsgfVxuICAgIGNvbnN0IHsgY29tcG9uZW50UGF0aCwgc2NoZW1hUGF0aCA9IFByb21pc2UucmVzb2x2ZShkZWZhdWx0T2JqZWN0U2NoZW1hQWxsb3dpbmdBbGxLZXlzKSB9ID0gY29tcG9uZW50UmVzb2x2ZXI7XG4gICAgY29uc3Qgc2NoZW1hID0gYXdhaXQgc2NoZW1hUGF0aDtcbiAgICBjb25zdCBpbnB1dCA9IHsgZGF0YTogdGhpcy5kYXRhLCBjb25maWc6IHRoaXMuY29uZmlnLCB0eXBlOiB0aGlzLnR5cGUgfVxuICAgIGNvbnN0IHsgZXJyb3IgfSA9IHZhbGlkYXRlSW5wdXRBZ2FpbnN0U2NoZW1hKHNjaGVtYSkoaW5wdXQpXG4gICAgaWYgKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoZXJyb3IubWVzc2FnZSlcbiAgICB9XG4gICAgY29uc3QgY29tcG9uZW50ID0gYXdhaXQgY29tcG9uZW50UGF0aDtcbiAgICB0aGlzLnJlcG9ydFdyYXBwZXIudmlld0NvbnRhaW5lclJlZi5jbGVhcigpO1xuICAgIGNvbnN0IGNvbXBvbmVudEZhY3RvcnkgPSB0aGlzLmNvbXBvbmVudEZhY3RvcnlSZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeTxjb21wb25lbnRJbnN0YW5jZVR5cGU+KGNvbXBvbmVudCk7XG4gICAgY29uc3QgY29tcG9uZW50UmVmID0gdGhpcy5yZXBvcnRXcmFwcGVyLnZpZXdDb250YWluZXJSZWYuY3JlYXRlQ29tcG9uZW50KGNvbXBvbmVudEZhY3RvcnkpO1xuICAgIGNvbnN0IGluc3RhbmNlID0gdGhpcy5pbnN0YW5jZSA9IGNvbXBvbmVudFJlZi5pbnN0YW5jZTtcbiAgICBpZiAodGhpcy50ZW1wbGF0ZVJlZnMubGVuZ3RoKSB7XG4gICAgICBpbnN0YW5jZVsndGVtcGxhdGVSZWZzJ10gPSB0aGlzLnRlbXBsYXRlUmVmcy50b0FycmF5KCkucmVkdWNlKHRyYW5zZm9ybVRlbXBsYXRlcywge30pO1xuICAgIH1cbiAgICBpbnN0YW5jZS5pZCA9IHRoaXMuaWQ7XG4gICAgaW5zdGFuY2UuaW5pdGlhbGl6ZSh7IGNvbmZpZzogdGhpcy5jb25maWcsIHR5cGU6IHRoaXMudHlwZSwgZGF0YTogdGhpcy5kYXRhIH0pO1xuICAgIGluc3RhbmNlLnN0YXRlLnN1YnNjcmliZSh0aGlzLl9zdGF0ZUV2ZW50c0hhbmRsZXIuYmluZCh0aGlzKSk7XG4gICAgaW5zdGFuY2UuZXZlbnRzLnN1YnNjcmliZSh0aGlzLl9ldmVudHNIYW5kbGVyLmJpbmQodGhpcykpO1xuICB9XG5cbiAgcHJpdmF0ZSBfc3RhdGVFdmVudHNIYW5kbGVyKGV2ZW50OiBSZXBvcnRTdGF0ZSkge1xuICAgIHRoaXMuZXZlbnRzLmVtaXQoeyB0eXBlOiAnU1RBVEUnLCBldmVudCB9KTtcbiAgfVxuXG4gIHByaXZhdGUgX2V2ZW50c0hhbmRsZXIoZXZlbnQ6IEN1c3RvbUV2ZW50KSB7XG4gICAgdGhpcy5ldmVudHMuZW1pdChldmVudCk7XG4gIH1cbiAgXG4gIHB1YmxpYyBmaWx0ZXIoZmlsdGVyZWREYXRhKSB7XG4gICAgdGhpcy5pbnN0YW5jZS51cGRhdGUoeyBkYXRhOiBmaWx0ZXJlZERhdGEgfSk7XG4gIH1cbiAgcHVibGljIHJlc2V0KCl7XG4gICAgdGhpcy5pbnN0YW5jZS5yZXNldCgpO1xuICB9XG59XG4iLCI8ZGl2PlxuICAgIDxuZy10ZW1wbGF0ZSBzYlJlcG9ydFdyYXBwZXI+PC9uZy10ZW1wbGF0ZT5cbjwvZGl2PiJdfQ==